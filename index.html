<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>성과 평가 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; background-color: #111827; color: #F9FAFB; }
        .card { background-color: #1F2937; border: 1px solid #374151; }
        .table-header { background-color: #374151; }
        .table-row:not(.comment-row):hover { background-color: #374151; }
        .btn-primary { background-color: #4F46E5; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338CA; }
        .btn-secondary { background-color: #4B5563; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #6B7280; }
        .btn-danger { color: #FCA5A5; }
        .btn-danger:hover { color: #F87171; }
        .comment-textarea { background-color: #111827; border-color: #4B5563; resize: vertical; min-height: 80px; }
        .remaining-bar { background-color: #374151; border-radius: 6px; overflow: hidden; }
        .remaining-bar-fill { background-color: #4F46E5; transition: width 0.3s ease-in-out; }
        .remaining-bar-fill.over { background-color: #EF4444; }
        .detail-section { background-color: #121A2A; }
        .input-field { background-color: #374151; }
        .input-field-green { background-color: #052e16; color: #a7f3d0; border-color: #34d399; }
        .readonly-field { background-color: #1F2937; color: #D1D5DB; border: 1px solid transparent; user-select: none; }
        .incentive-pool-field { background-color: #1e1b4b; color: #c7d2fe; border: 1px solid #4f46e5;}
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: #374151; min-width: 100px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 4px; }
        .dropdown-content a { color: #F9FAFB; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; cursor: pointer; }
        .dropdown-content a:hover { background-color: #4B5563; }
        .show { display: block; }
        #undo-toast { visibility: hidden; min-width: 250px; background-color: #1F2937; border: 1px solid #374151; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 50; left: 50%; transform: translateX(-50%); bottom: 30px; transition: visibility 0.5s, opacity 0.5s linear; opacity: 0; }
        #undo-toast.show { visibility: visible; opacity: 1; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .error-message {
            background-color: #991b1b;
            border: 1px solid #dc2626;
            color: #fecaca;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .success-message {
            background-color: #14532d;
            border: 1px solid #16a34a;
            color: #bbf7d0;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #1F2937;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #374151;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #fff;
        }
        /* 로그인 화면 스타일 */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-box {
            background-color: #1F2937;
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
        }
        /* 진행상태 뱃지 */
        .progress-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .progress-complete { background-color: #065f46; color: #a7f3d0; }
        .progress-partial { background-color: #7c2d12; color: #fed7aa; }
        .progress-none { background-color: #991b1b; color: #fecaca; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <!-- 로그인 화면 -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h1 class="text-2xl font-bold text-center mb-8">🚀 성과 평가 시스템</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">이메일</label>
                    <input type="email" id="login-email" class="w-full p-3 rounded-md input-field" placeholder="email@company.com" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">비밀번호</label>
                    <input type="password" id="login-password" class="w-full p-3 rounded-md input-field" placeholder="비밀번호 입력" required>
                </div>
                <button type="submit" class="w-full btn-primary text-white font-bold py-3 rounded-lg">로그인</button>
            </form>
            <div class="mt-4 text-center text-sm text-gray-400">
                기본 계정: admin@company.com / admin123
            </div>
        </div>
    </div>

    <!-- 메인 화면 -->
    <div id="main-screen" class="max-w-7xl mx-auto hidden">
        <header class="mb-8">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h1 class="text-3xl font-bold">🚀 성과 평가 시스템</h1>
                <div class="flex items-center gap-3 p-2 rounded-lg card">
                    <span class="text-sm font-medium">역할 전환:</span>
                    <div class="flex gap-2">
                        <button id="btn-team-lead" class="btn-secondary text-white font-bold py-2 px-3 rounded-lg text-sm">팀장</button>
                        <button id="btn-manager" class="btn-secondary text-white font-bold py-2 px-3 rounded-lg text-sm">관리자</button>
                        <button id="btn-final-approver" class="btn-secondary text-white font-bold py-2 px-3 rounded-lg text-sm">최종관리자</button>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex flex-wrap justify-between items-center gap-4">
                 <div class="flex items-center gap-3">
                     <span class="font-semibold text-lg" id="user-info"></span>
                     <a href="#" id="logout-btn" class="text-sm text-gray-400 hover:text-indigo-400">로그아웃</a>
                 </div>
                 <div class="flex items-center gap-4">
                     <div class="flex items-center gap-2" id="team-selector" style="display: none;">
                         <i data-lucide="users" class="w-5 h-5 text-gray-400"></i>
                         <select id="team-select" class="card p-2 rounded-md border-0 focus:ring-2 focus:ring-indigo-500">
                             <option value="">팀 선택...</option>
                         </select>
                     </div>
                     <div class="flex items-center gap-2">
                         <i data-lucide="calendar" class="w-5 h-5 text-gray-400"></i>
                         <select id="evaluation-month-select" class="card p-2 rounded-md border-0 focus:ring-2 focus:ring-indigo-500">
                             <option value="">월 선택...</option>
                         </select>
                     </div>
                 </div>
            </div>
        </header>

        <main class="pb-20">
            <div id="loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                <p class="mt-4 text-gray-400">데이터를 불러오는 중...</p>
            </div>
            
            <!-- 진행상태 대시보드 (최종관리자용) -->
            <div id="progress-dashboard" class="mb-8 hidden">
                <h2 class="text-xl font-semibold mb-4">평가 진행 현황</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="progress-cards">
                    <!-- 진행상태 카드들이 여기에 렌더링됨 -->
                </div>
            </div>
            
            <div id="team-lead-view" class="hidden"></div>
            <div id="manager-view" class="hidden"></div>
            <div id="final-approver-view" class="hidden"></div>
        </main>
    </div>
    
    <footer id="action-footer" class="fixed bottom-0 left-0 right-0 bg-gray-900/80 backdrop-blur-sm border-t border-gray-700 hidden">
        <div class="max-w-7xl mx-auto p-4 flex justify-end gap-3" id="footer-buttons">
            <!-- Buttons will be rendered here -->
        </div>
    </footer>

    <div id="undo-toast"><span id="undo-message"></span><button id="undo-btn" class="ml-4 text-indigo-400 font-bold">실행 취소</button></div>

    <!-- 담당자 추가 모달 -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-xl font-bold mb-4">새 담당자 추가</h2>
            <form id="addMemberForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">이름</label>
                    <input type="text" id="newMemberName" class="w-full p-2 rounded-md input-field" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">역할</label>
                    <select id="newMemberRole" class="w-full p-2 rounded-md input-field" required>
                        <option value="">선택하세요</option>
                        <option value="PD">PD</option>
                        <option value="편집자">편집자</option>
                        <option value="작가">작가</option>
                        <option value="디자이너">디자이너</option>
                        <option value="개발자">개발자</option>
                    </select>
                </div>
                <div class="flex justify-between mt-6">
                    <button type="button" class="btn-secondary px-4 py-2 rounded-lg" onclick="closeAddMemberModal()">취소</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-white">추가</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 시스템 관리자 추가 모달 -->
    <div id="addAdminModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddAdminModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">시스템 관리자 추가</h2>
            <form id="addAdminForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">이름</label>
                    <input type="text" id="adminName" class="w-full p-2 rounded-md input-field" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">이메일 (로그인 ID)</label>
                    <input type="email" id="adminEmail" class="w-full p-2 rounded-md input-field" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">비밀번호</label>
                    <input type="password" id="adminPassword" class="w-full p-2 rounded-md input-field" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">소속팀</label>
                    <select id="adminTeam" class="w-full p-2 rounded-md input-field" multiple size="3">
                        <!-- 팀 목록이 동적으로 추가됨 -->
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Ctrl+클릭으로 여러 팀 선택 가능</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">관리 역할</label>
                    <select id="adminRole" class="w-full p-2 rounded-md input-field" required>
                        <option value="">선택하세요</option>
                        <option value="팀장">팀장</option>
                        <option value="관리자">관리자</option>
                        <option value="최종관리자">최종관리자</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">평가 권한</label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="adminPerm1" class="mr-2">
                            <span>1차 평가</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="adminPerm2" class="mr-2">
                            <span>2차 평가</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="adminPerm3" class="mr-2">
                            <span>3차 평가</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button type="button" class="btn-secondary px-4 py-2 rounded-lg" onclick="closeAddAdminModal()">취소</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-white">추가</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
    // 전역 상태 관리
    let currentUser = null;
    let currentRole = null;
    let currentMonth = null;
    let selectedTeamId = null;
    let appData = {
        teams: [],
        channels: [],
        evaluations: [],
        users: [],      // 관리자들
        members: [],    // 담당자들
        progress: []
    };

    // DOM 요소 참조
    let views = {};
    let buttons = {};
    
    const formatCurrency = (num) => new Intl.NumberFormat('ko-KR').format(num);
    let undoState = { timer: null, element: null, parent: null, nextSibling: null };
    let pendingMemberData = null;

    // DOM 요소 초기화
    function initializeDOMReferences() {
        views = { 
            teamLead: document.getElementById('team-lead-view'), 
            manager: document.getElementById('manager-view'), 
            finalApprover: document.getElementById('final-approver-view') 
        };
        buttons = { 
            teamLead: document.getElementById('btn-team-lead'), 
            manager: document.getElementById('btn-manager'), 
            finalApprover: document.getElementById('btn-final-approver') 
        };
    }

    // Google Apps Script 통신 함수들
    function showLoading() {
        const loading = document.getElementById('loading');
        if (loading) loading.classList.remove('hidden');
        Object.values(views).forEach(view => {
            if (view) view.classList.add('hidden');
        });
    }

    function hideLoading() {
        const loading = document.getElementById('loading');
        if (loading) loading.classList.add('hidden');
        
        if (currentRole && views[currentRole]) {
            views[currentRole].classList.remove('hidden');
        }
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = '오류: ' + message;
        document.getElementById('main-screen').prepend(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
    }

    function showSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = message;
        document.getElementById('main-screen').prepend(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
    }

    // 세션 확인
    function checkUserSession() {
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    currentUser = result.user;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-screen').classList.remove('hidden');
                    document.getElementById('action-footer').classList.remove('hidden');
                    initializeApp();
                }
                // 세션이 없으면 로그인 화면 유지
            })
            .withFailureHandler(error => {
                console.log('세션 확인 실패:', error);
                // 로그인 화면 유지
            })
            .checkSession();
    }

    // 로그인 처리
    function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    currentUser = result.user;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-screen').classList.remove('hidden');
                    document.getElementById('action-footer').classList.remove('hidden');
                    initializeApp();
                } else {
                    hideLoading();
                    alert(result.message);
                }
            })
            .withFailureHandler(error => {
                hideLoading();
                alert('로그인 중 오류가 발생했습니다.');
            })
            .login(email, password);
    }

    // 로그아웃 처리
    function handleLogout(e) {
        e.preventDefault();
        google.script.run
            .withSuccessHandler(() => {
                currentUser = null;
                currentRole = null;
                currentMonth = null;
                selectedTeamId = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-screen').classList.add('hidden');
                document.getElementById('action-footer').classList.add('hidden');
                document.getElementById('login-form').reset();
            })
            .withFailureHandler(error => {
                console.error('로그아웃 오류:', error);
            })
            .logout();
    }

    // 모달 관련 함수
    function openAddMemberModal(channelId, teamId) {
        pendingMemberData = { channelId, teamId };
        document.getElementById('addMemberModal').style.display = 'block';
        document.getElementById('newMemberName').value = '';
        document.getElementById('newMemberRole').value = '';
    }

    function closeAddMemberModal() {
        document.getElementById('addMemberModal').style.display = 'none';
        pendingMemberData = null;
    }

    function openAddAdminModal() {
        document.getElementById('addAdminModal').style.display = 'block';
        const teamSelect = document.getElementById('adminTeam');
        teamSelect.innerHTML = '';
        appData.teams.forEach(team => {
            const option = document.createElement('option');
            option.value = team['팀ID'];
            option.textContent = team['팀이름'];
            teamSelect.appendChild(option);
        });
        document.getElementById('addAdminForm').reset();
    }

    function closeAddAdminModal() {
        document.getElementById('addAdminModal').style.display = 'none';
    }

    // 담당자 추가
    function addMemberToChannel(channelCard, memberData, channelId) {
        const memberList = channelCard.querySelector('.member-list');
        if (!memberList) return;
        
        const memberId = memberData['담당자ID'] || memberData['사용자ID'];
        const existingMember = memberList.querySelector(`tr[data-member-id="${memberId}"]`);
        if (existingMember) return;
        
        const newMemberHTML = createMemberRowHTML(memberData, channelId, currentRole, {});
        const tbody = memberList.closest('tbody');
        if (tbody) {
            tbody.insertAdjacentHTML('beforeend', newMemberHTML);
        } else {
            memberList.insertAdjacentHTML('beforeend', newMemberHTML);
        }
        
        initCalculations(channelCard);
        lucide.createIcons();
    }

    // 초기 데이터 로드
    function initializeApp() {
        if (!currentUser) return;
        
        document.getElementById('user-info').textContent = `${currentUser.이름}님`;
        
        // 권한에 따라 버튼 활성화/비활성화
        updateRoleButtons();
        
        // 팀 목록 설정
        if (currentUser.소속팀목록 && currentUser.소속팀목록.length > 1) {
            document.getElementById('team-selector').style.display = 'flex';
            selectedTeamId = currentUser.소속팀목록[0];
        }
        
        // 평가월 목록 로드
        loadMonths();
    }

    function loadMonths() {
        google.script.run
            .withSuccessHandler(months => {
                const monthSelect = document.getElementById('evaluation-month-select');
                monthSelect.innerHTML = '<option value="">월 선택...</option>';
                
                months.forEach(month => {
                    monthSelect.innerHTML += `<option value="${month}">${month}</option>`;
                });
                
                if (months.length > 0) {
                    currentMonth = months[0];
                    monthSelect.value = currentMonth;
                }
                
                // 기본 역할 선택
                if (currentUser.평가권한.includes('1차')) {
                    switchView('teamLead');
                } else if (currentUser.평가권한.includes('2차')) {
                    switchView('manager');
                } else if (currentUser.평가권한.includes('3차')) {
                    switchView('finalApprover');
                } else {
                    showError('평가 권한이 없습니다.');
                }
            })
            .withFailureHandler(error => {
                showError('평가월 목록을 불러오는데 실패했습니다.');
                hideLoading();
            })
            .getEvaluationMonths();
    }

    // 권한에 따른 역할 버튼 업데이트
    function updateRoleButtons() {
        if (!currentUser || !currentUser.평가권한) return;
        
        buttons.teamLead.disabled = !currentUser.평가권한.includes('1차');
        buttons.manager.disabled = !currentUser.평가권한.includes('2차');
        buttons.finalApprover.disabled = !currentUser.평가권한.includes('3차');
        
        Object.entries(buttons).forEach(([role, btn]) => {
            if (btn.disabled) {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
    }

    // 팀 선택 드롭다운 업데이트
    function updateTeamSelector() {
        const teamSelect = document.getElementById('team-select');
        if (!teamSelect || !currentUser.소속팀목록) return;
        
        teamSelect.innerHTML = '<option value="">팀 선택...</option>';
        
        currentUser.소속팀목록.forEach(teamId => {
            const team = appData.teams.find(t => t['팀ID'] === teamId);
            if (team) {
                const option = document.createElement('option');
                option.value = teamId;
                option.textContent = team['팀이름'];
                teamSelect.appendChild(option);
            }
        });
        
        teamSelect.value = selectedTeamId || currentUser.소속팀목록[0];
    }

    // 데이터 로드
    function loadData(role) {
        if (!currentUser || !currentMonth) return;

        showLoading();
        
        const roleToViewType = {
            '팀장': 'teamLead',
            '관리자': 'manager',
            '최종관리자': 'finalApprover'
        };
        const viewType = roleToViewType[role] || currentRole;
        
        google.script.run
            .withSuccessHandler(data => {
                appData = data;
                
                if (viewType === 'teamLead' && currentUser.소속팀목록 && currentUser.소속팀목록.length > 1) {
                    updateTeamSelector();
                }
                
                renderView(viewType);
                hideLoading();
                
                // 진행상태 대시보드 표시 (최종관리자)
                if (viewType === 'finalApprover') {
                    renderProgressDashboard();
                } else {
                    document.getElementById('progress-dashboard').classList.add('hidden');
                }
            })
            .withFailureHandler(error => {
                showError('데이터를 불러오는데 실패했습니다.');
                hideLoading();
            })
            .getDataByRole(currentUser.사용자ID, role, currentMonth);
    }

    // 진행상태 대시보드 렌더링
    function renderProgressDashboard() {
        const dashboard = document.getElementById('progress-dashboard');
        if (!dashboard) return;
        
        dashboard.classList.remove('hidden');
        
        const progressCards = document.getElementById('progress-cards');
        progressCards.innerHTML = '';
        
        // 팀별로 진행상태 집계
        appData.teams.forEach(team => {
            const teamChannels = appData.channels.filter(c => c['소속팀ID'] === team['팀ID']);
            const teamProgress = appData.progress.filter(p => p['팀ID'] === team['팀ID']);
            
            let total1 = 0, complete1 = 0;
            let total2 = 0, complete2 = 0;
            let total3 = 0, complete3 = 0;
            
            teamProgress.forEach(p => {
                const [comp1, tot1] = p['1차진행상태'].split('/').map(n => parseInt(n) || 0);
                const [comp2, tot2] = p['2차진행상태'].split('/').map(n => parseInt(n) || 0);
                const [comp3, tot3] = p['3차진행상태'].split('/').map(n => parseInt(n) || 0);
                
                total1 += tot1; complete1 += comp1;
                total2 += tot2; complete2 += comp2;
                total3 += tot3; complete3 += comp3;
            });
            
            const cardHTML = `
                <div class="card p-4 rounded-lg">
                    <h3 class="font-bold text-lg mb-3">${team['팀이름']}</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">1차 평가</span>
                            <span class="progress-badge ${complete1 === total1 ? 'progress-complete' : 'progress-partial'}">
                                ${complete1}/${total1}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">2차 평가</span>
                            <span class="progress-badge ${complete2 === total2 ? 'progress-complete' : 'progress-partial'}">
                                ${complete2}/${total2}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">3차 평가</span>
                            <span class="progress-badge ${complete3 === total3 ? 'progress-complete' : 'progress-partial'}">
                                ${complete3}/${total3}
                            </span>
                        </div>
                    </div>
                </div>`;
            
            progressCards.insertAdjacentHTML('beforeend', cardHTML);
        });
    }

    // 평가 데이터 저장
    function saveEvaluationData(evaluations, isDraft = false) {
        // 평가자 ID 추가
        evaluations.forEach(eval => {
            eval['평가자ID'] = currentUser.사용자ID;
        });
        
        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    const successMsg = isDraft ? 
                        '임시 저장되었습니다.' : 
                        (currentRole === 'teamLead' ? '1차 평가가 제출되었습니다.' :
                         currentRole === 'manager' ? '2차 평가가 저장되었습니다.' :
                         '최종 평가가 확정되었습니다.');
                    showSuccess(successMsg);
                    const roleMap = {
                        'teamLead': '팀장',
                        'manager': '관리자',
                        'finalApprover': '최종관리자'
                    };
                    loadData(roleMap[currentRole]);
                } else {
                    showError(result.message);
                    hideLoading();
                }
            })
            .withFailureHandler(error => {
                showError('저장 중 오류가 발생했습니다.');
                hideLoading();
            })
            .saveEvaluationBatch(evaluations);
    }

    // 동적 HTML 생성 함수들
    function createMemberRowHTML(member, channelId, viewType, evaluationData = {}) {
        const memberName = typeof member === 'string' ? member : member['이름'];
        const memberId = typeof member === 'string' ? member : member['사용자ID'];
        
        let colspan = viewType === 'manager' ? 5 : (viewType === 'finalApprover' ? 6 : 4);
        let rowHTML = `<tr class="table-row" data-member-id="${memberId}" data-member-name="${memberName}" data-channel-id="${channelId}">
            <td class="px-6 py-4 font-medium">${memberName}</td>`;
        
        if (viewType === 'teamLead') {
            rowHTML += `
                <td class="px-6 py-4"><input type="number" step="0.1" value="${evaluationData['투입MM'] || 0}" class="w-20 p-1 rounded-md border border-gray-600 mm-input input-field"></td>
                <td class="px-6 py-4"><input type="number" min="0" max="100" value="${evaluationData['1차기여도'] || 0}" class="w-20 p-1 rounded-md border border-gray-600 perc-input input-field"></td>`;
        } else if (viewType === 'manager') {
            rowHTML += `
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${evaluationData['투입MM'] || 0}</div></td>
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${evaluationData['1차기여도'] || 0}%</div></td>
                <td class="px-6 py-4"><input type="number" min="0" max="100" value="${evaluationData['2차기여도'] || 0}" class="w-20 p-1 rounded-md border border-gray-600 perc-input input-field"></td>`;
        } else if (viewType === 'finalApprover') {
            const contrib = evaluationData['2차기여도'] || 0;
            rowHTML += `
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${evaluationData['1차기여도'] || 0}%</div></td>
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${contrib}%</div></td>
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-32 contribution-incentive">0 만원</div></td>
                <td class="px-6 py-4"><input type="number" value="${evaluationData['실지급성과금'] || 0}" class="w-32 p-1 rounded-md border border-gray-600 final-incentive-input input-field"></td>`;
        }
        
        rowHTML += `
            <td class="px-6 py-4 text-center">
                <button class="toggle-comment hover:text-indigo-400"><i data-lucide="plus-circle"></i></button>
                <div class="dropdown inline-block ml-2">
                    <button class="toggle-menu p-1 rounded-full hover:bg-gray-600"><i data-lucide="more-vertical" class="w-4 h-4"></i></button>
                    <div class="dropdown-content">
                        <a class="remove-btn btn-danger">삭제</a>
                    </div>
                </div>
            </td>
        </tr>
        <tr class="comment-row hidden" data-member-id="${memberId}">
            <td colspan="${colspan}" class="p-0 detail-section">
                ${createCommentSectionHTML(viewType, evaluationData)}
            </td>
        </tr>`;
        
        return rowHTML;
    }

    function createCommentSectionHTML(viewType, evaluationData = {}) {
        let corePerformanceHTML = '';
        
        if (viewType === 'teamLead') {
            const performances = (evaluationData['1차성과내용'] || '').split('||').filter(p => p);
            corePerformanceHTML = `
                <div>
                    <h4 class="font-bold mb-3 flex items-center gap-2">📊 개인별 핵심 성과</h4>
                    <div class="text-sm space-y-2 core-performance-container">
                        <div class="grid grid-cols-5 gap-2 items-center">
                            <span class="col-span-2 text-gray-400">성과 항목</span>
                            <span class="col-span-3 text-gray-400">내용 및 수치</span>
                        </div>`;
            
            if (performances.length > 0) {
                performances.forEach(perf => {
                    const [title, value] = perf.split('|');
                    corePerformanceHTML += `
                        <div class="grid grid-cols-5 gap-2 items-center performance-item">
                            <input type="text" value="${title || ''}" placeholder="예: 최고 조회수 영상" class="col-span-2 bg-gray-800 rounded p-1 performance-title">
                            <input type="text" value="${value || ''}" placeholder="예: 우주다큐 (230만)" class="col-span-3 bg-gray-800 rounded p-1 performance-value">
                        </div>`;
                });
            } else {
                corePerformanceHTML += `
                        <div class="grid grid-cols-5 gap-2 items-center performance-item">
                            <input type="text" placeholder="예: 최고 조회수 영상" class="col-span-2 bg-gray-800 rounded p-1 performance-title">
                            <input type="text" placeholder="예: 우주다큐 (230만)" class="col-span-3 bg-gray-800 rounded p-1 performance-value">
                        </div>`;
            }
            
            corePerformanceHTML += `
                        <button class="text-indigo-400 hover:text-indigo-300 text-xs mt-2 add-performance-btn">+ 항목 추가</button>
                    </div>
                </div>`;
        } else {
            const performances = (evaluationData['1차성과내용'] || '').split('||').filter(p => p);
            let performanceText = '1차 평가 시 입력된 성과 내용이 여기에 표시됩니다.';
            if (performances.length > 0) {
                performanceText = performances.map(p => {
                    const [title, value] = p.split('|');
                    return `• ${title}: ${value}`;
                }).join('\n');
            }
            
            corePerformanceHTML = `
                <div>
                    <h4 class="font-bold mb-3 flex items-center gap-2">📊 1차 핵심 성과</h4>
                    <p class="text-sm text-gray-300 readonly-field p-2 rounded-md whitespace-pre-line">${performanceText}</p>
                </div>`;
        }
        
        if (viewType === 'teamLead') {
            return `
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${corePerformanceHTML}
                    <div>
                        <h4 class="font-bold mb-3 flex items-center gap-2">💬 1차 코멘트</h4>
                        <textarea class="w-full p-2 border rounded-md comment-textarea input-field comment-1" placeholder="1차 평가 코멘트를 기록해주세요.">${evaluationData['1차코멘트'] || ''}</textarea>
                    </div>
                </div>`;
        } else if (viewType === 'manager') {
            return `
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${corePerformanceHTML}
                    <div>
                        <h4 class="font-bold mb-2 flex items-center gap-2">💬 1차 코멘트 (팀장)</h4>
                        <p class="text-sm text-gray-300 readonly-field p-2 rounded-md mb-2">${evaluationData['1차코멘트'] || '1차 평가가 아직 제출되지 않았습니다.'}</p>
                        <h4 class="font-bold mb-2 flex items-center gap-2">💬 2차 코멘트</h4>
                        <textarea class="w-full p-2 border rounded-md comment-textarea input-field comment-2" placeholder="2차 평가 코멘트를 기록해주세요.">${evaluationData['2차코멘트'] || ''}</textarea>
                    </div>
                </div>`;
        } else if (viewType === 'finalApprover') {
            return `
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${corePerformanceHTML}
                    <div>
                        <h4 class="font-bold mb-2 flex items-center gap-2">💬 1차 코멘트 (팀장)</h4>
                        <p class="text-sm text-gray-300 readonly-field p-2 rounded-md">${evaluationData['1차코멘트'] || '1차 평가가 아직 제출되지 않았습니다.'}</p>
                        <h4 class="font-bold mt-4 mb-2 flex items-center gap-2">💬 2차 코멘트 (관리자)</h4>
                        <p class="text-sm text-gray-300 readonly-field p-2 rounded-md">${evaluationData['2차코멘트'] || '2차 평가가 아직 제출되지 않았습니다.'}</p>
                        <h4 class="font-bold mt-4 mb-2 flex items-center gap-2">💬 최종 코멘트</h4>
                        <textarea class="w-full p-2 border rounded-md comment-textarea input-field comment-final" placeholder="최종 코멘트를 기록해주세요.">${evaluationData['최종코멘트'] || ''}</textarea>
                    </div>
                </div>`;
        }
        return '';
    }

    function createChannelHTML(channel, viewType) {
        const channelId = channel['채널ID'];
        const channelName = channel['채널이름'];
        
        const channelEvaluations = appData.evaluations.filter(e => e['채널ID'] === channelId);
        
        let members = [];
        if (channelEvaluations.length > 0) {
            const memberIds = [...new Set(channelEvaluations.map(e => e['담당자ID']))];
            members = memberIds.map(id => appData.users.find(u => u['사용자ID'] === id)).filter(Boolean);
        }
        
        let tableHeader = '';
        if (viewType === 'teamLead') {
            tableHeader = `<tr><th class="px-6 py-3">담당자</th><th class="px-6 py-3">투입 MM</th><th class="px-6 py-3">1차 기여도 (%)</th><th class="px-6 py-3 text-center">상세 정보</th></tr>`;
        } else if (viewType === 'manager') {
            tableHeader = `<tr><th class="px-6 py-3">담당자</th><th class="px-6 py-3">투입MM</th><th class="px-6 py-3">1차 기여도(참고)</th><th class="px-6 py-3">2차 기여도 (%)</th><th class="px-6 py-3 text-center">상세 정보</th></tr>`;
        } else if (viewType === 'finalApprover') {
            tableHeader = `<tr><th class="px-6 py-3">담당자</th><th class="px-6 py-3">1차 기여도</th><th class="px-6 py-3">2차 기여도</th><th class="px-6 py-3">기여도성과금(참고)</th><th class="px-6 py-3">실지급 성과금(만원)</th><th class="px-6 py-3 text-center">상세 정보</th></tr>`;
        }
        
        let budgetSection = '';
        if(viewType === 'finalApprover') {
            const channelBudget = channelEvaluations[0] || {};
            budgetSection = `
                <div class="p-5 border-y border-gray-700">
                    <div class="grid grid-cols-12 gap-x-4 gap-y-2 items-end">
                        <div class="col-span-12 sm:col-span-6 md:col-span-2 flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-400">사업효율(%)</label>
                            <div class="relative">
                                <input type="number" value="${channelBudget['사업효율'] || 80}" class="w-full p-2 pr-6 rounded-md text-lg font-bold text-center efficiency-input input-field input-field-green">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">%</span>
                            </div>
                        </div>
                        <div class="col-span-12 sm:col-span-6 md:col-span-3 flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-400">1차 성과금(만원)</label>
                            <input type="number" value="${channelBudget['팀장성과금'] || 500}" class="w-full p-2 rounded-md text-lg font-bold text-center incentive1-input input-field">
                        </div>
                        <div class="col-span-12 sm:col-span-6 md:col-span-3 flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-400">팀장성과(%)</label>
                            <input type="number" value="${channelBudget['팀장성과'] || 20}" class="w-full p-2 rounded-md text-lg font-bold text-center lead-perc-input input-field">
                        </div>
                        <div class="col-span-12 md:col-span-4 flex flex-col gap-1">
                            <h4 class="text-sm font-medium text-gray-400">2차 성과금 (배분대상)</h4>
                            <div class="mt-1 p-2 rounded-md text-lg font-bold incentive-pool-field incentive2-output">400 만원</div>
                            <div class="w-full mt-1 remaining-bar">
                                <div class="h-2 remaining-bar-fill incentive-progress-bar-fill" style="width: 0%;"></div>
                            </div>
                            <p class="text-xs text-right text-gray-400 incentive-ratio mt-1"></p>
                        </div>
                    </div>
                </div>`;
        }

        const membersHTML = members.map(member => {
            const evalData = channelEvaluations.find(e => e['담당자ID'] === member['사용자ID']) || {};
            return createMemberRowHTML(member, channelId, viewType, evalData);
        }).join('');
        
        let footer = '';
        if (viewType === 'teamLead') {
            footer = `<tfoot class="font-semibold table-header"><tr><td class="px-6 py-3 text-right">합계</td><td class="px-6 py-3 font-bold total-mm">0.0</td><td class="px-6 py-3 font-bold total-perc">0%</td><td><button class="add-member-btn text-indigo-300 hover:text-indigo-100 text-xs ml-4">+ 담당자</button></td></tr></tfoot>`;
        } else if (viewType === 'manager') {
            footer = `<tfoot class="font-semibold table-header"><tr><td class="px-6 py-3 text-right" colspan="3">합계</td><td class="px-6 py-3 font-bold total-perc">0%</td><td>${members.length === 0 ? '<button class="add-member-btn text-indigo-300 hover:text-indigo-100 text-xs ml-4">+ 담당자</button>' : ''}</td></tr></tfoot>`;
        } else if (viewType === 'finalApprover') {
            footer = `<tfoot class="font-semibold table-header"><tr><td class="px-6 py-3 text-right" colspan="4">실지급 합계</td><td class="px-6 py-3 font-bold total-final-incentive">0 만원</td><td>${members.length === 0 ? '<button class="add-member-btn text-indigo-300 hover:text-indigo-100 text-xs ml-4">+ 담당자</button>' : ''}</td></tr></tfoot>`;
        }

        return `
            <div class="card rounded-lg shadow-md" data-channel-id="${channelId}">
                <div class="p-5">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <button class="toggle-channel-comment p-1 rounded-full hover:bg-gray-700"><i data-lucide="plus-circle"></i></button>
                            <h3 class="text-xl font-bold">${channelName}</h3>
                        </div>
                        <div class="dropdown">
                            <button class="toggle-menu p-1 rounded-full hover:bg-gray-600"><i data-lucide="more-vertical" class="w-4 h-4"></i></button>
                            <div class="dropdown-content">
                                <a class="remove-btn btn-danger">채널 삭제</a>
                            </div>
                        </div>
                    </div>
                    ${viewType !== 'finalApprover' ? `
                    <div class="mt-3 text-sm text-gray-400">
                        <span>잔여 기여도: </span>
                        <span class="font-bold text-lg text-green-400 remaining-perc">100%</span>
                        <div class="w-full mt-1 remaining-bar">
                            <div class="h-2 remaining-bar-fill" style="width: 0%;"></div>
                        </div>
                    </div>` : ''}
                </div>
                <div class="channel-comment-section hidden p-4 border-y border-gray-700 detail-section">
                    <h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="clipboard-edit"></i>채널 종합 코멘트</h4>
                    <textarea class="w-full p-2 border rounded-md comment-textarea channel-comment" placeholder="채널 전체에 대한 종합 코멘트를 기록해주세요.">${channelEvaluations[0]?.['채널코멘트'] || ''}</textarea>
                </div>
                ${budgetSection}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="table-header">${tableHeader}</thead>
                        <tbody class="member-list">${membersHTML}</tbody>
                        ${footer}
                    </table>
                </div>
            </div>`;
    }
    
    function createTeamCardHTML(team, viewType) {
        const teamId = team['팀ID'];
        const teamName = team['팀이름'];
        const teamChannels = appData.channels.filter(c => c['소속팀ID'] === teamId);
        
        const channelsHTML = teamChannels.map(channel => createChannelHTML(channel, viewType)).join('');
        
        return `
            <div class="card rounded-lg shadow-md" data-team-id="${teamId}">
                <div class="p-5 bg-gray-800 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">${teamName}</h2>
                        <div class="dropdown">
                            <button class="toggle-menu p-1 rounded-full hover:bg-gray-600"><i data-lucide="more-vertical"></i></button>
                            <div class="dropdown-content">
                                <a class="remove-btn btn-danger">팀 삭제</a>
                                <a class="add-channel-btn">채널 추가</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 space-y-8 channel-container">${channelsHTML}</div>
            </div>`;
    }

    function renderView(viewType) {
        const container = views[viewType];
        if (!container) return;
        
        let contentHTML = '';
        let footerHTML = '';

        if (viewType === 'teamLead') {
            const teamId = selectedTeamId || currentUser.소속팀ID.split(',')[0].trim();
            const userTeam = appData.teams.find(t => t['팀ID'] === teamId);
            
            if (!userTeam) {
                contentHTML = '<p class="error-message">소속 팀을 찾을 수 없습니다.</p>';
            } else {
                const teamChannels = appData.channels.filter(c => c['소속팀ID'] === userTeam['팀ID']);
                const channelsHTML = teamChannels.map(channel => createChannelHTML(channel, 'teamLead')).join('');
                contentHTML = `
                    <h2 class="text-2xl font-semibold mb-4">${userTeam['팀이름']} 성과 입력 (1차)</h2>
                    <div class="space-y-8 channel-container">${channelsHTML}</div>
                    <div class="mt-4">
                        <button class="add-channel-btn btn-secondary text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            <i data-lucide="plus"></i> 채널 추가
                        </button>
                    </div>`;
                footerHTML = `
                    <button class="btn-secondary py-3 px-6 text-base rounded-lg save-draft-btn">임시 저장</button>
                    <button class="btn-primary py-3 px-6 text-base rounded-lg submit-evaluation-btn">1차 평가 최종 제출</button>`;
            }
        } else {
            const teamCardsHTML = appData.teams.map(team => createTeamCardHTML(team, viewType)).join('');
            const title = viewType === 'manager' ? '전체 성과 취합 (2차)' : '최종 성과금 입력 (3차)';
            const buttons = viewType === 'finalApprover' ? 
                `<button class="btn-secondary py-3 px-6 text-base rounded-lg save-draft-btn">저장하기</button>
                 <button class="btn-primary py-3 px-6 text-base rounded-lg submit-evaluation-btn">이달의 평가 최종 확정</button>` : 
                `<button class="btn-primary py-3 px-6 text-base rounded-lg submit-evaluation-btn">2차 평가 저장</button>`;
            
            contentHTML = `
                <h2 class="text-2xl font-semibold mb-4">${title}</h2>
                <div class="space-y-8" id="${viewType}-cards">${teamCardsHTML}</div>
                <div class="mt-4 flex gap-4">
                    <button class="add-team-btn btn-secondary text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="plus"></i> 팀 추가
                    </button>
                    ${viewType === 'finalApprover' ? `
                    <button class="add-admin-btn btn-secondary text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="user-plus"></i> 시스템 관리자 추가
                    </button>` : ''}
                </div>`;
            footerHTML = buttons;
        }
        
        container.innerHTML = contentHTML;
        document.getElementById('footer-buttons').innerHTML = footerHTML;
        
        initCalculations(container);
        lucide.createIcons();
    }

    // Undo 기능
    function showUndoToast(message, elementToRemove) {
        clearTimeout(undoState.timer);
        const toast = document.getElementById('undo-toast');
        document.getElementById('undo-message').textContent = message;

        undoState.element = elementToRemove;
        undoState.parent = elementToRemove.parentNode;
        undoState.nextSibling = elementToRemove.nextElementSibling;
        
        elementToRemove.style.display = 'none';
        toast.classList.add('show');
        
        undoState.timer = setTimeout(() => {
            if (undoState.element && undoState.element.parentNode) {
                undoState.element.remove();
            }
            hideUndoToast();
        }, 5000);
    }

    function hideUndoToast() {
        const toast = document.getElementById('undo-toast');
        toast.classList.remove('show');
        clearTimeout(undoState.timer);
        undoState = { timer: null, element: null, parent: null, nextSibling: null };
    }

    // 이벤트 위임
    document.getElementById('main-screen').addEventListener('click', (e) => {
        const target = e.target;

        // 드롭다운 메뉴
        const menuBtn = target.closest('.toggle-menu');
        if (menuBtn) {
            e.preventDefault();
            const dropdownContent = menuBtn.nextElementSibling;
            document.querySelectorAll('.dropdown-content.show').forEach(d => {
                if (d !== dropdownContent) d.classList.remove('show');
            });
            dropdownContent.classList.toggle('show');
            return;
        }
        if (!target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-content.show').forEach(d => d.classList.remove('show'));
        }

        // 삭제 버튼
        if (target.closest('.remove-btn')) {
            e.preventDefault();
            let elementToRemove;
            let message = "항목이 삭제되었습니다.";

            const memberRow = target.closest('tr.table-row');
            if (memberRow) {
                elementToRemove = memberRow;
                const commentRow = memberRow.nextElementSibling;
                if (commentRow && commentRow.classList.contains('comment-row')) {
                    commentRow.remove();
                }
                message = `${memberRow.dataset.memberName} 님이 삭제되었습니다.`;
            } else {
                const card = target.closest('.card[data-channel-id]') || target.closest('.card[data-team-id]');
                if (card) {
                    elementToRemove = card;
                    message = card.dataset.channelId ? "채널이 삭제되었습니다." : "팀이 삭제되었습니다.";
                }
            }
            
            if (elementToRemove) {
                showUndoToast(message, elementToRemove);
                target.closest('.dropdown-content').classList.remove('show');
            }
            return;
        }

        // 코멘트 토글
        const toggleBtn = target.closest('.toggle-comment, .toggle-channel-comment');
        if (toggleBtn) {
            e.preventDefault();
            const isMemberComment = toggleBtn.classList.contains('toggle-comment');
            const section = isMemberComment 
                ? toggleBtn.closest('tr').nextElementSibling 
                : toggleBtn.closest('.card').querySelector('.channel-comment-section');
            
            section.classList.toggle('hidden');
            toggleBtn.innerHTML = section.classList.contains('hidden') ? '<i data-lucide="plus-circle"></i>' : '<i data-lucide="minus-circle"></i>';
            lucide.createIcons();
            return;
        }

        // 성과 항목 추가
        if (target.closest('.add-performance-btn')) {
            e.preventDefault();
            const container = target.closest('.core-performance-container');
            const newItem = document.createElement('div');
            newItem.className = 'grid grid-cols-5 gap-2 items-center performance-item';
            newItem.innerHTML = `
                <input type="text" placeholder="예: 최고 조회수 영상" class="col-span-2 bg-gray-800 rounded p-1 performance-title">
                <input type="text" placeholder="예: 우주다큐 (230만)" class="col-span-3 bg-gray-800 rounded p-1 performance-value">`;
            container.insertBefore(newItem, target);
            return;
        }

        // 담당자 추가
        if (target.closest('.add-member-btn')) {
            e.preventDefault();
            const channelCard = target.closest('.card[data-channel-id]');
            const channelId = channelCard.dataset.channelId;
            const channel = appData.channels.find(c => c['채널ID'] === channelId);
            const teamId = channel ? channel['소속팀ID'] : null;
            openAddMemberModal(channelId, teamId);
            return;
        }

        // 채널 추가
        if (target.closest('.add-channel-btn')) {
            const teamCard = target.closest('.card[data-team-id]');
            const teamId = teamCard ? teamCard.dataset.teamId : (selectedTeamId || currentUser.소속팀ID.split(',')[0].trim());
            const channelName = prompt('새 채널 이름을 입력하세요:');
            
            if (channelName) {
                showLoading();
                google.script.run
                    .withSuccessHandler(result => {
                        if (result.success) {
                            showSuccess('채널이 추가되었습니다.');
                            const roleMap = {
                                'teamLead': '팀장',
                                'manager': '관리자',
                                'finalApprover': '최종관리자'
                            };
                            loadData(roleMap[currentRole]);
                        } else {
                            showError(result.message);
                            hideLoading();
                        }
                    })
                    .withFailureHandler(error => {
                        showError('채널 추가 중 오류가 발생했습니다.');
                        hideLoading();
                    })
                    .addChannel({ name: channelName, teamId: teamId });
            }
            return;
        }

        // 팀 추가
        if (target.closest('.add-team-btn')) {
            const teamName = prompt('새 팀 이름을 입력하세요:');
            
            if (teamName) {
                showLoading();
                google.script.run
                    .withSuccessHandler(result => {
                        if (result.success) {
                            showSuccess('팀이 추가되었습니다.');
                            const roleMap = {
                                'teamLead': '팀장',
                                'manager': '관리자',
                                'finalApprover': '최종관리자'
                            };
                            loadData(roleMap[currentRole]);
                        } else {
                            showError(result.message);
                            hideLoading();
                        }
                    })
                    .withFailureHandler(error => {
                        showError('팀 추가 중 오류가 발생했습니다.');
                        hideLoading();
                    })
                    .addTeam({ name: teamName });
            }
            return;
        }

        // 시스템 관리자 추가
        if (target.closest('.add-admin-btn')) {
            e.preventDefault();
            openAddAdminModal();
            return;
        }
    });

    // footer 버튼 이벤트
    document.getElementById('action-footer').addEventListener('click', (e) => {
        const target = e.target;
        
        if (target.closest('.save-draft-btn, .submit-evaluation-btn')) {
            e.preventDefault();
            const isDraft = target.closest('.save-draft-btn') !== null;
            collectAndSaveData(isDraft);
            return;
        }
    });

    // 계산 로직 초기화
    function initCalculations(scopeElement) {
        if (!scopeElement) return;

        const cards = scopeElement.matches('.card[data-channel-id]') ? [scopeElement] : scopeElement.querySelectorAll('.card[data-channel-id]');
        
        cards.forEach(card => {
            const calculate = () => {
                // 기여도 계산
                const percInputs = card.querySelectorAll('.perc-input');
                if (percInputs.length > 0) {
                    let totalPerc = 0;
                    percInputs.forEach(input => { 
                        totalPerc += parseFloat(input.value) || 0; 
                    });
                    
                    const remaining = 100 - totalPerc;
                    const remainingEl = card.querySelector('.remaining-perc');
                    if (remainingEl) {
                        remainingEl.textContent = `${remaining}%`;
                        remainingEl.classList.toggle('text-red-500', remaining < 0);
                        remainingEl.classList.toggle('text-green-400', remaining >= 0);
                    }
                    const remainingBarFill = card.querySelector('.remaining-bar-fill');
                    if(remainingBarFill) {
                        remainingBarFill.style.width = `${Math.min(100, totalPerc)}%`;
                        remainingBarFill.classList.toggle('over', totalPerc > 100);
                    }
                    
                    const totalPercEl = card.querySelector('.total-perc');
                    if (totalPercEl) totalPercEl.textContent = `${totalPerc}%`;
                }
                
                // MM 계산
                const mmInputs = card.querySelectorAll('.mm-input');
                if (mmInputs.length > 0) {
                    let totalMM = 0; 
                    mmInputs.forEach(input => { 
                        totalMM += parseFloat(input.value) || 0; 
                    });
                    const totalMMEl = card.querySelector('.total-mm');
                    if (totalMMEl) totalMMEl.textContent = totalMM.toFixed(1);
                }
                
                // 최종 성과금 계산
                if (card.querySelector('.incentive1-input')) {
                    const incentive1 = parseFloat(card.querySelector('.incentive1-input').value) || 0;
                    const leadPerc = (parseFloat(card.querySelector('.lead-perc-input').value) || 0) / 100;
                    const incentive2ForDistribution = incentive1 * (1 - leadPerc);

                    let totalManualPaid = 0;
                    card.querySelectorAll('.final-incentive-input').forEach(input => {
                        totalManualPaid += parseFloat(input.value) || 0;
                    });
                    
                    const totalFinalIncentiveEl = card.querySelector('.total-final-incentive');
                    if(totalFinalIncentiveEl) {
                        totalFinalIncentiveEl.textContent = `${formatCurrency(totalManualPaid)} 만원`;
                    }

                    const incentive2OutputEl = card.querySelector('.incentive2-output');
                    if(incentive2OutputEl) {
                        incentive2OutputEl.textContent = `${formatCurrency(incentive2ForDistribution.toFixed(0))} 만원`;
                    }
                    
                    const incentiveRatioEl = card.querySelector('.incentive-ratio');
                    if(incentiveRatioEl) {
                        const ratio = incentive2ForDistribution > 0 ? (totalManualPaid / incentive2ForDistribution * 100) : 0;
                        incentiveRatioEl.textContent = `${formatCurrency(totalManualPaid)} / ${formatCurrency(incentive2ForDistribution.toFixed(0))} 만원 (${ratio.toFixed(0)}%)`;
                        incentiveRatioEl.classList.toggle('text-red-400', ratio > 100);
                    }

                    const progressPercentage = incentive2ForDistribution > 0 ? (totalManualPaid / incentive2ForDistribution) * 100 : 0;
                    const incentiveProgressBar = card.querySelector('.incentive-progress-bar-fill');
                    if(incentiveProgressBar) {
                        incentiveProgressBar.style.width = `${Math.min(100, progressPercentage)}%`;
                        incentiveProgressBar.classList.toggle('over', progressPercentage > 100);
                    }

                    // 자동 계산된 기여도 성과금
                    let totalContribution = 0;
                    const memberRows = card.querySelectorAll('tr[data-member-name]');
                    memberRows.forEach(row => {
                        const cell = row.cells[2];
                        if(cell) {
                            const text = cell.textContent.replace('%', '');
                            totalContribution += parseFloat(text) || 0;
                        }
                    });

                    memberRows.forEach(row => {
                        const contributionCell = row.cells[2];
                        if(contributionCell) {
                            const contributionText = contributionCell.textContent.replace('%', '');
                            const contribution = parseFloat(contributionText) || 0;
                            const autoCalculatedIncentive = totalContribution > 0 ? (contribution / totalContribution) * incentive2ForDistribution : 0;
                            const incentiveDiv = row.querySelector('.contribution-incentive');
                            if (incentiveDiv) {
                                incentiveDiv.textContent = `${formatCurrency(autoCalculatedIncentive.toFixed(0))} 만원`;
                            }
                        }
                    });
                }
            };

            card.addEventListener('input', e => {
                if (e.target.matches('.perc-input, .mm-input, .incentive1-input, .lead-perc-input, .final-incentive-input')) {
                    calculate();
                }
            });
            calculate();
        });
    }

    // 데이터 수집 및 저장
    function collectAndSaveData(isDraft = false) {
        const evaluations = [];
        
        document.querySelectorAll('.card[data-channel-id]').forEach(channelCard => {
            const channelId = channelCard.dataset.channelId;
            const channelComment = channelCard.querySelector('.channel-comment')?.value || '';
            
            let channelBudget = {};
            if (currentRole === 'finalApprover') {
                channelBudget = {
                    사업효율: parseFloat(channelCard.querySelector('.efficiency-input')?.value) || 80,
                    팀장성과금: parseFloat(channelCard.querySelector('.incentive1-input')?.value) || 0,
                    팀장성과: parseFloat(channelCard.querySelector('.lead-perc-input')?.value) || 0
                };
            }
            
            channelCard.querySelectorAll('tr[data-member-id]').forEach(memberRow => {
                const memberId = memberRow.dataset.memberId;
                const memberName = memberRow.dataset.memberName;
                
                let evalData = appData.evaluations.find(e => 
                    e['채널ID'] === channelId && 
                    e['담당자ID'] === memberId && 
                    e['평가월'] === currentMonth
                );
                
                if (!evalData) {
                    evalData = {
                        평가ID: null,
                        평가월: currentMonth,
                        채널ID: channelId,
                        담당자ID: memberId,
                        담당자이름: memberName
                    };
                } else {
                    evalData = { ...evalData };
                }
                
                if (currentRole === 'teamLead') {
                    evalData['투입MM'] = parseFloat(memberRow.querySelector('.mm-input')?.value) || 0;
                    evalData['1차기여도'] = parseFloat(memberRow.querySelector('.perc-input')?.value) || 0;
                    
                    const commentRow = memberRow.nextElementSibling;
                    if (commentRow) {
                        const performances = [];
                        commentRow.querySelectorAll('.performance-item').forEach(item => {
                            const title = item.querySelector('.performance-title')?.value;
                            const value = item.querySelector('.performance-value')?.value;
                            if (title || value) {
                                performances.push(`${title}|${value}`);
                            }
                        });
                        evalData['1차성과내용'] = performances.join('||');
                        evalData['1차코멘트'] = commentRow.querySelector('.comment-1')?.value || '';
                    }
                    evalData['1차평가상태'] = isDraft ? '임시저장' : '제출완료';
                } else if (currentRole === 'manager') {
                    evalData['2차기여도'] = parseFloat(memberRow.querySelector('.perc-input')?.value) || 0;
                    
                    const commentRow = memberRow.nextElementSibling;
                    if (commentRow) {
                        evalData['2차코멘트'] = commentRow.querySelector('.comment-2')?.value || '';
                    }
                    evalData['2차평가상태'] = isDraft ? '임시저장' : '제출완료';
                } else if (currentRole === 'finalApprover') {
                    evalData['실지급성과금'] = parseFloat(memberRow.querySelector('.final-incentive-input')?.value) || 0;
                    evalData['사업효율'] = channelBudget.사업효율;
                    evalData['팀장성과금'] = channelBudget.팀장성과금;
                    evalData['팀장성과'] = channelBudget.팀장성과;
                    
                    const commentRow = memberRow.nextElementSibling;
                    if (commentRow) {
                        evalData['최종코멘트'] = commentRow.querySelector('.comment-final')?.value || '';
                    }
                    evalData['최종평가상태'] = isDraft ? '임시저장' : '제출완료';
                }
                
                evalData['채널코멘트'] = channelComment;
                evalData['담당자이름'] = memberName;
                evaluations.push(evalData);
            });
        });
        
        if (evaluations.length > 0) {
            saveEvaluationData(evaluations, isDraft);
        } else {
            showError('저장할 데이터가 없습니다.');
        }
    }

    // 역할 전환
    function switchView(role) {
        if (!currentUser) return;
        
        const roleMap = {
            'teamLead': '팀장',
            'manager': '관리자', 
            'finalApprover': '최종관리자'
        };
        
        const permissionMap = {
            'teamLead': '1차',
            'manager': '2차',
            'finalApprover': '3차'
        };
        
        if (!currentUser.평가권한 || !currentUser.평가권한.includes(permissionMap[role])) {
            showError(`${roleMap[role]} 평가 권한이 없습니다.`);
            return;
        }
        
        currentRole = role;
        
        Object.values(views).forEach(view => { 
            if (view) view.classList.add('hidden'); 
        });
        
        Object.values(buttons).forEach(btn => { 
            if (btn) {
                btn.classList.remove('btn-primary'); 
                btn.classList.add('btn-secondary'); 
            }
        });
        
        buttons[role].classList.remove('btn-secondary');
        buttons[role].classList.add('btn-primary');
        
        document.getElementById('user-info').textContent = `${currentUser.이름}님 (${roleMap[role]})`;
        
        loadData(roleMap[role]);
    }

    // DOM 로드 완료 후 초기화
    window.addEventListener('DOMContentLoaded', function() {
        initializeDOMReferences();
        
        // 세션 확인 - 로그인 상태 유지
        checkUserSession();
        
        // 로그인 폼 이벤트
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        
        // 로그아웃 버튼 이벤트
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        
        // 역할 전환 버튼 이벤트
        buttons.teamLead.addEventListener('click', () => {
            if (currentUser && !buttons.teamLead.disabled) switchView('teamLead');
        });
        buttons.manager.addEventListener('click', () => {
            if (currentUser && !buttons.manager.disabled) switchView('manager');
        });
        buttons.finalApprover.addEventListener('click', () => {
            if (currentUser && !buttons.finalApprover.disabled) switchView('finalApprover');
        });
        
        // 월 선택 이벤트
        document.getElementById('evaluation-month-select').addEventListener('change', (e) => {
            currentMonth = e.target.value;
            if (currentMonth && currentRole && currentUser) {
                const roleMap = {
                    'teamLead': '팀장',
                    'manager': '관리자',
                    'finalApprover': '최종관리자'
                };
                loadData(roleMap[currentRole]);
            }
        });
        
        // 팀 선택 이벤트
        document.getElementById('team-select').addEventListener('change', (e) => {
            selectedTeamId = e.target.value;
            if (selectedTeamId && currentRole === 'teamLead') {
                loadData('팀장');
            }
        });
        
        // Undo 버튼 이벤트
        document.getElementById('undo-btn').addEventListener('click', () => {
            if (undoState.element) {
                undoState.element.style.display = '';
                hideUndoToast();
            }
        });
        
        // 모달 닫기 버튼
        document.querySelector('.close').addEventListener('click', closeAddMemberModal);
        document.querySelector('#addAdminModal .close').addEventListener('click', closeAddAdminModal);
        
        // 모달 밖 클릭 시 닫기
        window.addEventListener('click', (event) => {
            const modal1 = document.getElementById('addMemberModal');
            const modal2 = document.getElementById('addAdminModal');
            if (event.target === modal1) {
                closeAddMemberModal();
            } else if (event.target === modal2) {
                closeAddAdminModal();
            }
        });

        // 관리자 역할 선택 시 기본 권한 자동 설정
        document.getElementById('adminRole').addEventListener('change', (e) => {
            const role = e.target.value;
            document.getElementById('adminPerm1').checked = role === '팀장';
            document.getElementById('adminPerm2').checked = role === '관리자';
            document.getElementById('adminPerm3').checked = role === '최종관리자';
        });
        
        // 담당자 추가 폼 제출
        document.getElementById('addMemberForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const userData = {
                name: document.getElementById('newMemberName').value,
                role: document.getElementById('newMemberRole').value,
                teamId: pendingMemberData.teamId
            };
            
            // 로딩 표시 대신 버튼만 비활성화
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = '추가 중...';
            
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        showSuccess('담당자가 추가되었습니다.');
                        closeAddMemberModal();
                        
                        // 화면에 즉시 추가 (데이터 리로드 없이)
                        const channelCard = document.querySelector(`[data-channel-id="${pendingMemberData.channelId}"]`);
                        if (channelCard && result.member) {
                            // appData에 추가
                            appData.members.push(result.member);
                            
                            // 화면에 바로 렌더링
                            addMemberToChannel(channelCard, result.member, pendingMemberData.channelId);
                        }
                    } else {
                        showError(result.message);
                    }
                    submitBtn.disabled = false;
                    submitBtn.textContent = '추가';
                })
                .withFailureHandler(error => {
                    showError('담당자 추가 중 오류가 발생했습니다.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = '추가';
                })
                .addMember(userData);  // addUser 대신 addMember 호출
        });

        // 시스템 관리자 추가 폼 제출
        document.getElementById('addAdminForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const teamSelect = document.getElementById('adminTeam');
            const selectedTeams = Array.from(teamSelect.selectedOptions).map(opt => opt.value);
            
            const adminData = {
                userId: document.getElementById('adminEmail').value,
                name: document.getElementById('adminName').value,
                password: document.getElementById('adminPassword').value,
                role: document.getElementById('adminRole').value,
                teamId: selectedTeams.join(','),
                permissions: {
                    perm1: document.getElementById('adminPerm1').checked,
                    perm2: document.getElementById('adminPerm2').checked,
                    perm3: document.getElementById('adminPerm3').checked
                }
            };
            
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        showSuccess('시스템 관리자가 추가되었습니다.');
                        closeAddAdminModal();
                        const roleMap = {
                            'teamLead': '팀장',
                            'manager': '관리자',
                            'finalApprover': '최종관리자'
                        };
                        loadData(roleMap[currentRole]);
                    } else {
                        showError(result.message);
                    }
                    hideLoading();
                })
                .withFailureHandler(error => {
                    showError('시스템 관리자 추가 중 오류가 발생했습니다.');
                    hideLoading();
                })
                .addUser(adminData);
        });
    });
    </script>
</body>
</html>
