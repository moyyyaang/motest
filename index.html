<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; background-color: #111827; color: #F9FAFB; }
        .card { background-color: #1F2937; border: 1px solid #374151; }
        .table-header { background-color: #374151; }
        .table-row:not(.comment-row):hover { background-color: #374151; }
        .btn-primary { background-color: #4F46E5; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338CA; }
        .btn-secondary { background-color: #4B5563; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #6B7280; }
        .btn-danger { color: #FCA5A5; }
        .btn-danger:hover { color: #F87171; }
        .comment-textarea { background-color: #111827; border-color: #4B5563; resize: vertical; min-height: 80px; }
        .remaining-bar { background-color: #374151; border-radius: 6px; overflow: hidden; }
        .remaining-bar-fill { background-color: #4F46E5; transition: width 0.3s ease-in-out; }
        .remaining-bar-fill.over { background-color: #EF4444; }
        .detail-section { background-color: #121A2A; }
        .input-field { background-color: #374151; }
        .input-field-green { background-color: #052e16; color: #a7f3d0; border-color: #34d399; }
        .readonly-field { background-color: #1F2937; color: #D1D5DB; border: 1px solid transparent; user-select: none; }
        .incentive-pool-field { background-color: #1e1b4b; color: #c7d2fe; border: 1px solid #4f46e5;}
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: #374151; min-width: 100px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 4px; }
        .dropdown-content a { color: #F9FAFB; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; cursor: pointer; }
        .dropdown-content a:hover { background-color: #4B5563; }
        .show { display: block; }
        #undo-toast { visibility: hidden; min-width: 250px; background-color: #1F2937; border: 1px solid #374151; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 50; left: 50%; transform: translateX(-50%); bottom: 30px; transition: visibility 0.5s, opacity 0.5s linear; opacity: 0; }
        #undo-toast.show { visibility: visible; opacity: 1; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .error-message {
            background-color: #991b1b;
            border: 1px solid #dc2626;
            color: #fecaca;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .success-message {
            background-color: #14532d;
            border: 1px solid #16a34a;
            color: #bbf7d0;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #1F2937;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #374151;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #fff;
        }
        /* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-box {
            background-color: #1F2937;
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
        }
        /* ì§„í–‰ìƒíƒœ ë±ƒì§€ */
        .progress-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .progress-complete { background-color: #065f46; color: #a7f3d0; }
        .progress-partial { background-color: #7c2d12; color: #fed7aa; }
        .progress-none { background-color: #991b1b; color: #fecaca; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h1 class="text-2xl font-bold text-center mb-8">ğŸš€ ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œ</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ì´ë©”ì¼</label>
                    <input type="email" id="login-email" class="w-full p-3 rounded-md input-field" placeholder="email@company.com" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="login-password" class="w-full p-3 rounded-md input-field" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required>
                </div>
                <button type="submit" class="w-full btn-primary text-white font-bold py-3 rounded-lg">ë¡œê·¸ì¸</button>
            </form>
            <div class="mt-4 text-center text-sm text-gray-400">
                ê¸°ë³¸ ê³„ì •: admin@company.com / admin123
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ í™”ë©´ -->
    <div id="main-screen" class="max-w-7xl mx-auto hidden">
        <header class="mb-8">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h1 class="text-3xl font-bold">ğŸš€ ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œ</h1>
                <div class="flex items-center gap-3 p-2 rounded-lg card">
                    <span class="text-sm font-medium">ì—­í•  ì „í™˜:</span>
                    <div class="flex gap-2">
                        <button id="btn-team-lead" class="btn-secondary text-white font-bold py-2 px-3 rounded-lg text-sm">íŒ€ì¥</button>
                        <button id="btn-manager" class="btn-secondary text-white font-bold py-2 px-3 rounded-lg text-sm">ê´€ë¦¬ì</button>
                        <button id="btn-final-approver" class="btn-secondary text-white font-bold py-2 px-3 rounded-lg text-sm">ìµœì¢…ê´€ë¦¬ì</button>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex flex-wrap justify-between items-center gap-4">
                 <div class="flex items-center gap-3">
                     <span class="font-semibold text-lg" id="user-info"></span>
                     <a href="#" id="logout-btn" class="text-sm text-gray-400 hover:text-indigo-400">ë¡œê·¸ì•„ì›ƒ</a>
                 </div>
                 <div class="flex items-center gap-4">
                     <div class="flex items-center gap-2" id="team-selector" style="display: none;">
                         <i data-lucide="users" class="w-5 h-5 text-gray-400"></i>
                         <select id="team-select" class="card p-2 rounded-md border-0 focus:ring-2 focus:ring-indigo-500">
                             <option value="">íŒ€ ì„ íƒ...</option>
                         </select>
                     </div>
                     <div class="flex items-center gap-2">
                         <i data-lucide="calendar" class="w-5 h-5 text-gray-400"></i>
                         <select id="evaluation-month-select" class="card p-2 rounded-md border-0 focus:ring-2 focus:ring-indigo-500">
                             <option value="">ì›” ì„ íƒ...</option>
                         </select>
                     </div>
                 </div>
            </div>
        </header>

        <main class="pb-20">
            <div id="loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                <p class="mt-4 text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            
            <!-- ì§„í–‰ìƒíƒœ ëŒ€ì‹œë³´ë“œ (ìµœì¢…ê´€ë¦¬ììš©) -->
            <div id="progress-dashboard" class="mb-8 hidden">
                <h2 class="text-xl font-semibold mb-4">í‰ê°€ ì§„í–‰ í˜„í™©</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="progress-cards">
                    <!-- ì§„í–‰ìƒíƒœ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
                </div>
            </div>
            
            <div id="team-lead-view" class="hidden"></div>
            <div id="manager-view" class="hidden"></div>
            <div id="final-approver-view" class="hidden"></div>
        </main>
    </div>
    
    <footer id="action-footer" class="fixed bottom-0 left-0 right-0 bg-gray-900/80 backdrop-blur-sm border-t border-gray-700 hidden">
        <div class="max-w-7xl mx-auto p-4 flex justify-end gap-3" id="footer-buttons">
            <!-- Buttons will be rendered here -->
        </div>
    </footer>

    <div id="undo-toast"><span id="undo-message"></span><button id="undo-btn" class="ml-4 text-indigo-400 font-bold">ì‹¤í–‰ ì·¨ì†Œ</button></div>

    <!-- ë‹´ë‹¹ì ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-xl font-bold mb-4">ìƒˆ ë‹´ë‹¹ì ì¶”ê°€</h2>
            <form id="addMemberForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ì´ë¦„</label>
                    <input type="text" id="newMemberName" class="w-full p-2 rounded-md input-field" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ì—­í• </label>
                    <select id="newMemberRole" class="w-full p-2 rounded-md input-field" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="PD">PD</option>
                        <option value="í¸ì§‘ì">í¸ì§‘ì</option>
                        <option value="ì‘ê°€">ì‘ê°€</option>
                        <option value="ë””ìì´ë„ˆ">ë””ìì´ë„ˆ</option>
                        <option value="ê°œë°œì">ê°œë°œì</option>
                    </select>
                </div>
                <div class="flex justify-between mt-6">
                    <button type="button" class="btn-secondary px-4 py-2 rounded-lg" onclick="closeAddMemberModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-white">ì¶”ê°€</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addAdminModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddAdminModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€</h2>
            <form id="addAdminForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ì´ë¦„</label>
                    <input type="text" id="adminName" class="w-full p-2 rounded-md input-field" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ì´ë©”ì¼ (ë¡œê·¸ì¸ ID)</label>
                    <input type="email" id="adminEmail" class="w-full p-2 rounded-md input-field" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="adminPassword" class="w-full p-2 rounded-md input-field" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ì†Œì†íŒ€</label>
                    <select id="adminTeam" class="w-full p-2 rounded-md input-field" multiple size="3">
                        <!-- íŒ€ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Ctrl+í´ë¦­ìœ¼ë¡œ ì—¬ëŸ¬ íŒ€ ì„ íƒ ê°€ëŠ¥</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ê´€ë¦¬ ì—­í• </label>
                    <select id="adminRole" class="w-full p-2 rounded-md input-field" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="íŒ€ì¥">íŒ€ì¥</option>
                        <option value="ê´€ë¦¬ì">ê´€ë¦¬ì</option>
                        <option value="ìµœì¢…ê´€ë¦¬ì">ìµœì¢…ê´€ë¦¬ì</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">í‰ê°€ ê¶Œí•œ</label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="adminPerm1" class="mr-2">
                            <span>1ì°¨ í‰ê°€</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="adminPerm2" class="mr-2">
                            <span>2ì°¨ í‰ê°€</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="adminPerm3" class="mr-2">
                            <span>3ì°¨ í‰ê°€</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button type="button" class="btn-secondary px-4 py-2 rounded-lg" onclick="closeAddAdminModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-white">ì¶”ê°€</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
    // ì „ì—­ ìƒíƒœ ê´€ë¦¬
    let currentUser = null;
    let currentRole = null;
    let currentMonth = null;
    let selectedTeamId = null;
    let appData = {
        teams: [],
        channels: [],
        evaluations: [],
        users: [],      // ê´€ë¦¬ìë“¤
        members: [],    // ë‹´ë‹¹ìë“¤
        progress: []
    };

    // DOM ìš”ì†Œ ì°¸ì¡°
    let views = {};
    let buttons = {};
    
    const formatCurrency = (num) => new Intl.NumberFormat('ko-KR').format(num);
    let undoState = { timer: null, element: null, parent: null, nextSibling: null };
    let pendingMemberData = null;

    // DOM ìš”ì†Œ ì´ˆê¸°í™”
    function initializeDOMReferences() {
        views = { 
            teamLead: document.getElementById('team-lead-view'), 
            manager: document.getElementById('manager-view'), 
            finalApprover: document.getElementById('final-approver-view') 
        };
        buttons = { 
            teamLead: document.getElementById('btn-team-lead'), 
            manager: document.getElementById('btn-manager'), 
            finalApprover: document.getElementById('btn-final-approver') 
        };
    }

    // Google Apps Script í†µì‹  í•¨ìˆ˜ë“¤
    function showLoading() {
        const loading = document.getElementById('loading');
        if (loading) loading.classList.remove('hidden');
        Object.values(views).forEach(view => {
            if (view) view.classList.add('hidden');
        });
    }

    function hideLoading() {
        const loading = document.getElementById('loading');
        if (loading) loading.classList.add('hidden');
        
        if (currentRole && views[currentRole]) {
            views[currentRole].classList.remove('hidden');
        }
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = 'ì˜¤ë¥˜: ' + message;
        document.getElementById('main-screen').prepend(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
    }

    function showSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = message;
        document.getElementById('main-screen').prepend(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
    }

    // ì„¸ì…˜ í™•ì¸
    function checkUserSession() {
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    currentUser = result.user;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-screen').classList.remove('hidden');
                    document.getElementById('action-footer').classList.remove('hidden');
                    initializeApp();
                }
                // ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í™”ë©´ ìœ ì§€
            })
            .withFailureHandler(error => {
                console.log('ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨:', error);
                // ë¡œê·¸ì¸ í™”ë©´ ìœ ì§€
            })
            .checkSession();
    }

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    currentUser = result.user;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-screen').classList.remove('hidden');
                    document.getElementById('action-footer').classList.remove('hidden');
                    initializeApp();
                } else {
                    hideLoading();
                    alert(result.message);
                }
            })
            .withFailureHandler(error => {
                hideLoading();
                alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .login(email, password);
    }

    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    function handleLogout(e) {
        e.preventDefault();
        google.script.run
            .withSuccessHandler(() => {
                currentUser = null;
                currentRole = null;
                currentMonth = null;
                selectedTeamId = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-screen').classList.add('hidden');
                document.getElementById('action-footer').classList.add('hidden');
                document.getElementById('login-form').reset();
            })
            .withFailureHandler(error => {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
            })
            .logout();
    }

    // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
    function openAddMemberModal(channelId, teamId) {
        pendingMemberData = { channelId, teamId };
        document.getElementById('addMemberModal').style.display = 'block';
        document.getElementById('newMemberName').value = '';
        document.getElementById('newMemberRole').value = '';
    }

    function closeAddMemberModal() {
        document.getElementById('addMemberModal').style.display = 'none';
        pendingMemberData = null;
    }

    function openAddAdminModal() {
        document.getElementById('addAdminModal').style.display = 'block';
        const teamSelect = document.getElementById('adminTeam');
        teamSelect.innerHTML = '';
        appData.teams.forEach(team => {
            const option = document.createElement('option');
            option.value = team['íŒ€ID'];
            option.textContent = team['íŒ€ì´ë¦„'];
            teamSelect.appendChild(option);
        });
        document.getElementById('addAdminForm').reset();
    }

    function closeAddAdminModal() {
        document.getElementById('addAdminModal').style.display = 'none';
    }

    // ë‹´ë‹¹ì ì¶”ê°€
    function addMemberToChannel(channelCard, memberData, channelId) {
        const memberList = channelCard.querySelector('.member-list');
        if (!memberList) return;
        
        const memberId = memberData['ë‹´ë‹¹ìID'] || memberData['ì‚¬ìš©ìID'];
        const existingMember = memberList.querySelector(`tr[data-member-id="${memberId}"]`);
        if (existingMember) return;
        
        const newMemberHTML = createMemberRowHTML(memberData, channelId, currentRole, {});
        const tbody = memberList.closest('tbody');
        if (tbody) {
            tbody.insertAdjacentHTML('beforeend', newMemberHTML);
        } else {
            memberList.insertAdjacentHTML('beforeend', newMemberHTML);
        }
        
        initCalculations(channelCard);
        lucide.createIcons();
    }

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    function initializeApp() {
        if (!currentUser) return;
        
        document.getElementById('user-info').textContent = `${currentUser.ì´ë¦„}ë‹˜`;
        
        // ê¶Œí•œì— ë”°ë¼ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        updateRoleButtons();
        
        // íŒ€ ëª©ë¡ ì„¤ì •
        if (currentUser.ì†Œì†íŒ€ëª©ë¡ && currentUser.ì†Œì†íŒ€ëª©ë¡.length > 1) {
            document.getElementById('team-selector').style.display = 'flex';
            selectedTeamId = currentUser.ì†Œì†íŒ€ëª©ë¡[0];
        }
        
        // í‰ê°€ì›” ëª©ë¡ ë¡œë“œ
        loadMonths();
    }

    function loadMonths() {
        google.script.run
            .withSuccessHandler(months => {
                const monthSelect = document.getElementById('evaluation-month-select');
                monthSelect.innerHTML = '<option value="">ì›” ì„ íƒ...</option>';
                
                months.forEach(month => {
                    monthSelect.innerHTML += `<option value="${month}">${month}</option>`;
                });
                
                if (months.length > 0) {
                    currentMonth = months[0];
                    monthSelect.value = currentMonth;
                }
                
                // ê¸°ë³¸ ì—­í•  ì„ íƒ
                if (currentUser.í‰ê°€ê¶Œí•œ.includes('1ì°¨')) {
                    switchView('teamLead');
                } else if (currentUser.í‰ê°€ê¶Œí•œ.includes('2ì°¨')) {
                    switchView('manager');
                } else if (currentUser.í‰ê°€ê¶Œí•œ.includes('3ì°¨')) {
                    switchView('finalApprover');
                } else {
                    showError('í‰ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                }
            })
            .withFailureHandler(error => {
                showError('í‰ê°€ì›” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                hideLoading();
            })
            .getEvaluationMonths();
    }

    // ê¶Œí•œì— ë”°ë¥¸ ì—­í•  ë²„íŠ¼ ì—…ë°ì´íŠ¸
    function updateRoleButtons() {
        if (!currentUser || !currentUser.í‰ê°€ê¶Œí•œ) return;
        
        buttons.teamLead.disabled = !currentUser.í‰ê°€ê¶Œí•œ.includes('1ì°¨');
        buttons.manager.disabled = !currentUser.í‰ê°€ê¶Œí•œ.includes('2ì°¨');
        buttons.finalApprover.disabled = !currentUser.í‰ê°€ê¶Œí•œ.includes('3ì°¨');
        
        Object.entries(buttons).forEach(([role, btn]) => {
            if (btn.disabled) {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
    }

    // íŒ€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    function updateTeamSelector() {
        const teamSelect = document.getElementById('team-select');
        if (!teamSelect || !currentUser.ì†Œì†íŒ€ëª©ë¡) return;
        
        teamSelect.innerHTML = '<option value="">íŒ€ ì„ íƒ...</option>';
        
        currentUser.ì†Œì†íŒ€ëª©ë¡.forEach(teamId => {
            const team = appData.teams.find(t => t['íŒ€ID'] === teamId);
            if (team) {
                const option = document.createElement('option');
                option.value = teamId;
                option.textContent = team['íŒ€ì´ë¦„'];
                teamSelect.appendChild(option);
            }
        });
        
        teamSelect.value = selectedTeamId || currentUser.ì†Œì†íŒ€ëª©ë¡[0];
    }

    // ë°ì´í„° ë¡œë“œ
    function loadData(role) {
        if (!currentUser || !currentMonth) return;

        showLoading();
        
        const roleToViewType = {
            'íŒ€ì¥': 'teamLead',
            'ê´€ë¦¬ì': 'manager',
            'ìµœì¢…ê´€ë¦¬ì': 'finalApprover'
        };
        const viewType = roleToViewType[role] || currentRole;
        
        google.script.run
            .withSuccessHandler(data => {
                appData = data;
                
                if (viewType === 'teamLead' && currentUser.ì†Œì†íŒ€ëª©ë¡ && currentUser.ì†Œì†íŒ€ëª©ë¡.length > 1) {
                    updateTeamSelector();
                }
                
                renderView(viewType);
                hideLoading();
                
                // ì§„í–‰ìƒíƒœ ëŒ€ì‹œë³´ë“œ í‘œì‹œ (ìµœì¢…ê´€ë¦¬ì)
                if (viewType === 'finalApprover') {
                    renderProgressDashboard();
                } else {
                    document.getElementById('progress-dashboard').classList.add('hidden');
                }
            })
            .withFailureHandler(error => {
                showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                hideLoading();
            })
            .getDataByRole(currentUser.ì‚¬ìš©ìID, role, currentMonth);
    }

    // ì§„í–‰ìƒíƒœ ëŒ€ì‹œë³´ë“œ ë Œë”ë§
    function renderProgressDashboard() {
        const dashboard = document.getElementById('progress-dashboard');
        if (!dashboard) return;
        
        dashboard.classList.remove('hidden');
        
        const progressCards = document.getElementById('progress-cards');
        progressCards.innerHTML = '';
        
        // íŒ€ë³„ë¡œ ì§„í–‰ìƒíƒœ ì§‘ê³„
        appData.teams.forEach(team => {
            const teamChannels = appData.channels.filter(c => c['ì†Œì†íŒ€ID'] === team['íŒ€ID']);
            const teamProgress = appData.progress.filter(p => p['íŒ€ID'] === team['íŒ€ID']);
            
            let total1 = 0, complete1 = 0;
            let total2 = 0, complete2 = 0;
            let total3 = 0, complete3 = 0;
            
            teamProgress.forEach(p => {
                const [comp1, tot1] = p['1ì°¨ì§„í–‰ìƒíƒœ'].split('/').map(n => parseInt(n) || 0);
                const [comp2, tot2] = p['2ì°¨ì§„í–‰ìƒíƒœ'].split('/').map(n => parseInt(n) || 0);
                const [comp3, tot3] = p['3ì°¨ì§„í–‰ìƒíƒœ'].split('/').map(n => parseInt(n) || 0);
                
                total1 += tot1; complete1 += comp1;
                total2 += tot2; complete2 += comp2;
                total3 += tot3; complete3 += comp3;
            });
            
            const cardHTML = `
                <div class="card p-4 rounded-lg">
                    <h3 class="font-bold text-lg mb-3">${team['íŒ€ì´ë¦„']}</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">1ì°¨ í‰ê°€</span>
                            <span class="progress-badge ${complete1 === total1 ? 'progress-complete' : 'progress-partial'}">
                                ${complete1}/${total1}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">2ì°¨ í‰ê°€</span>
                            <span class="progress-badge ${complete2 === total2 ? 'progress-complete' : 'progress-partial'}">
                                ${complete2}/${total2}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">3ì°¨ í‰ê°€</span>
                            <span class="progress-badge ${complete3 === total3 ? 'progress-complete' : 'progress-partial'}">
                                ${complete3}/${total3}
                            </span>
                        </div>
                    </div>
                </div>`;
            
            progressCards.insertAdjacentHTML('beforeend', cardHTML);
        });
    }

    // í‰ê°€ ë°ì´í„° ì €ì¥
    function saveEvaluationData(evaluations, isDraft = false) {
        // í‰ê°€ì ID ì¶”ê°€
        evaluations.forEach(eval => {
            eval['í‰ê°€ìID'] = currentUser.ì‚¬ìš©ìID;
        });
        
        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    const successMsg = isDraft ? 
                        'ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 
                        (currentRole === 'teamLead' ? '1ì°¨ í‰ê°€ê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.' :
                         currentRole === 'manager' ? '2ì°¨ í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' :
                         'ìµœì¢… í‰ê°€ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    showSuccess(successMsg);
                    const roleMap = {
                        'teamLead': 'íŒ€ì¥',
                        'manager': 'ê´€ë¦¬ì',
                        'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
                    };
                    loadData(roleMap[currentRole]);
                } else {
                    showError(result.message);
                    hideLoading();
                }
            })
            .withFailureHandler(error => {
                showError('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                hideLoading();
            })
            .saveEvaluationBatch(evaluations);
    }

    // ë™ì  HTML ìƒì„± í•¨ìˆ˜ë“¤
    function createMemberRowHTML(member, channelId, viewType, evaluationData = {}) {
        const memberName = typeof member === 'string' ? member : member['ì´ë¦„'];
        const memberId = typeof member === 'string' ? member : member['ì‚¬ìš©ìID'];
        
        let colspan = viewType === 'manager' ? 5 : (viewType === 'finalApprover' ? 6 : 4);
        let rowHTML = `<tr class="table-row" data-member-id="${memberId}" data-member-name="${memberName}" data-channel-id="${channelId}">
            <td class="px-6 py-4 font-medium">${memberName}</td>`;
        
        if (viewType === 'teamLead') {
            rowHTML += `
                <td class="px-6 py-4"><input type="number" step="0.1" value="${evaluationData['íˆ¬ì…MM'] || 0}" class="w-20 p-1 rounded-md border border-gray-600 mm-input input-field"></td>
                <td class="px-6 py-4"><input type="number" min="0" max="100" value="${evaluationData['1ì°¨ê¸°ì—¬ë„'] || 0}" class="w-20 p-1 rounded-md border border-gray-600 perc-input input-field"></td>`;
        } else if (viewType === 'manager') {
            rowHTML += `
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${evaluationData['íˆ¬ì…MM'] || 0}</div></td>
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${evaluationData['1ì°¨ê¸°ì—¬ë„'] || 0}%</div></td>
                <td class="px-6 py-4"><input type="number" min="0" max="100" value="${evaluationData['2ì°¨ê¸°ì—¬ë„'] || 0}" class="w-20 p-1 rounded-md border border-gray-600 perc-input input-field"></td>`;
        } else if (viewType === 'finalApprover') {
            const contrib = evaluationData['2ì°¨ê¸°ì—¬ë„'] || 0;
            rowHTML += `
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${evaluationData['1ì°¨ê¸°ì—¬ë„'] || 0}%</div></td>
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${contrib}%</div></td>
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-32 contribution-incentive">0 ë§Œì›</div></td>
                <td class="px-6 py-4"><input type="number" value="${evaluationData['ì‹¤ì§€ê¸‰ì„±ê³¼ê¸ˆ'] || 0}" class="w-32 p-1 rounded-md border border-gray-600 final-incentive-input input-field"></td>`;
        }
        
        rowHTML += `
            <td class="px-6 py-4 text-center">
                <button class="toggle-comment hover:text-indigo-400"><i data-lucide="plus-circle"></i></button>
                <div class="dropdown inline-block ml-2">
                    <button class="toggle-menu p-1 rounded-full hover:bg-gray-600"><i data-lucide="more-vertical" class="w-4 h-4"></i></button>
                    <div class="dropdown-content">
                        <a class="remove-btn btn-danger">ì‚­ì œ</a>
                    </div>
                </div>
            </td>
        </tr>
        <tr class="comment-row hidden" data-member-id="${memberId}">
            <td colspan="${colspan}" class="p-0 detail-section">
                ${createCommentSectionHTML(viewType, evaluationData)}
            </td>
        </tr>`;
        
        return rowHTML;
    }

    function createCommentSectionHTML(viewType, evaluationData = {}) {
        let corePerformanceHTML = '';
        
        if (viewType === 'teamLead') {
            const performances = (evaluationData['1ì°¨ì„±ê³¼ë‚´ìš©'] || '').split('||').filter(p => p);
            corePerformanceHTML = `
                <div>
                    <h4 class="font-bold mb-3 flex items-center gap-2">ğŸ“Š ê°œì¸ë³„ í•µì‹¬ ì„±ê³¼</h4>
                    <div class="text-sm space-y-2 core-performance-container">
                        <div class="grid grid-cols-5 gap-2 items-center">
                            <span class="col-span-2 text-gray-400">ì„±ê³¼ í•­ëª©</span>
                            <span class="col-span-3 text-gray-400">ë‚´ìš© ë° ìˆ˜ì¹˜</span>
                        </div>`;
            
            if (performances.length > 0) {
                performances.forEach(perf => {
                    const [title, value] = perf.split('|');
                    corePerformanceHTML += `
                        <div class="grid grid-cols-5 gap-2 items-center performance-item">
                            <input type="text" value="${title || ''}" placeholder="ì˜ˆ: ìµœê³  ì¡°íšŒìˆ˜ ì˜ìƒ" class="col-span-2 bg-gray-800 rounded p-1 performance-title">
                            <input type="text" value="${value || ''}" placeholder="ì˜ˆ: ìš°ì£¼ë‹¤í (230ë§Œ)" class="col-span-3 bg-gray-800 rounded p-1 performance-value">
                        </div>`;
                });
            } else {
                corePerformanceHTML += `
                        <div class="grid grid-cols-5 gap-2 items-center performance-item">
                            <input type="text" placeholder="ì˜ˆ: ìµœê³  ì¡°íšŒìˆ˜ ì˜ìƒ" class="col-span-2 bg-gray-800 rounded p-1 performance-title">
                            <input type="text" placeholder="ì˜ˆ: ìš°ì£¼ë‹¤í (230ë§Œ)" class="col-span-3 bg-gray-800 rounded p-1 performance-value">
                        </div>`;
            }
            
            corePerformanceHTML += `
                        <button class="text-indigo-400 hover:text-indigo-300 text-xs mt-2 add-performance-btn">+ í•­ëª© ì¶”ê°€</button>
                    </div>
                </div>`;
        } else {
            const performances = (evaluationData['1ì°¨ì„±ê³¼ë‚´ìš©'] || '').split('||').filter(p => p);
            let performanceText = '1ì°¨ í‰ê°€ ì‹œ ì…ë ¥ëœ ì„±ê³¼ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
            if (performances.length > 0) {
                performanceText = performances.map(p => {
                    const [title, value] = p.split('|');
                    return `â€¢ ${title}: ${value}`;
                }).join('\n');
            }
            
            corePerformanceHTML = `
                <div>
                    <h4 class="font-bold mb-3 flex items-center gap-2">ğŸ“Š 1ì°¨ í•µì‹¬ ì„±ê³¼</h4>
                    <p class="text-sm text-gray-300 readonly-field p-2 rounded-md whitespace-pre-line">${performanceText}</p>
                </div>`;
        }
        
        if (viewType === 'teamLead') {
            return `
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${corePerformanceHTML}
                    <div>
                        <h4 class="font-bold mb-3 flex items-center gap-2">ğŸ’¬ 1ì°¨ ì½”ë©˜íŠ¸</h4>
                        <textarea class="w-full p-2 border rounded-md comment-textarea input-field comment-1" placeholder="1ì°¨ í‰ê°€ ì½”ë©˜íŠ¸ë¥¼ ê¸°ë¡í•´ì£¼ì„¸ìš”.">${evaluationData['1ì°¨ì½”ë©˜íŠ¸'] || ''}</textarea>
                    </div>
                </div>`;
        } else if (viewType === 'manager') {
            return `
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${corePerformanceHTML}
                    <div>
                        <h4 class="font-bold mb-2 flex items-center gap-2">ğŸ’¬ 1ì°¨ ì½”ë©˜íŠ¸ (íŒ€ì¥)</h4>
                        <p class="text-sm text-gray-300 readonly-field p-2 rounded-md mb-2">${evaluationData['1ì°¨ì½”ë©˜íŠ¸'] || '1ì°¨ í‰ê°€ê°€ ì•„ì§ ì œì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                        <h4 class="font-bold mb-2 flex items-center gap-2">ğŸ’¬ 2ì°¨ ì½”ë©˜íŠ¸</h4>
                        <textarea class="w-full p-2 border rounded-md comment-textarea input-field comment-2" placeholder="2ì°¨ í‰ê°€ ì½”ë©˜íŠ¸ë¥¼ ê¸°ë¡í•´ì£¼ì„¸ìš”.">${evaluationData['2ì°¨ì½”ë©˜íŠ¸'] || ''}</textarea>
                    </div>
                </div>`;
        } else if (viewType === 'finalApprover') {
            return `
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${corePerformanceHTML}
                    <div>
                        <h4 class="font-bold mb-2 flex items-center gap-2">ğŸ’¬ 1ì°¨ ì½”ë©˜íŠ¸ (íŒ€ì¥)</h4>
                        <p class="text-sm text-gray-300 readonly-field p-2 rounded-md">${evaluationData['1ì°¨ì½”ë©˜íŠ¸'] || '1ì°¨ í‰ê°€ê°€ ì•„ì§ ì œì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                        <h4 class="font-bold mt-4 mb-2 flex items-center gap-2">ğŸ’¬ 2ì°¨ ì½”ë©˜íŠ¸ (ê´€ë¦¬ì)</h4>
                        <p class="text-sm text-gray-300 readonly-field p-2 rounded-md">${evaluationData['2ì°¨ì½”ë©˜íŠ¸'] || '2ì°¨ í‰ê°€ê°€ ì•„ì§ ì œì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                        <h4 class="font-bold mt-4 mb-2 flex items-center gap-2">ğŸ’¬ ìµœì¢… ì½”ë©˜íŠ¸</h4>
                        <textarea class="w-full p-2 border rounded-md comment-textarea input-field comment-final" placeholder="ìµœì¢… ì½”ë©˜íŠ¸ë¥¼ ê¸°ë¡í•´ì£¼ì„¸ìš”.">${evaluationData['ìµœì¢…ì½”ë©˜íŠ¸'] || ''}</textarea>
                    </div>
                </div>`;
        }
        return '';
    }

    function createChannelHTML(channel, viewType) {
        const channelId = channel['ì±„ë„ID'];
        const channelName = channel['ì±„ë„ì´ë¦„'];
        
        const channelEvaluations = appData.evaluations.filter(e => e['ì±„ë„ID'] === channelId);
        
        let members = [];
        if (channelEvaluations.length > 0) {
            const memberIds = [...new Set(channelEvaluations.map(e => e['ë‹´ë‹¹ìID']))];
            members = memberIds.map(id => appData.users.find(u => u['ì‚¬ìš©ìID'] === id)).filter(Boolean);
        }
        
        let tableHeader = '';
        if (viewType === 'teamLead') {
            tableHeader = `<tr><th class="px-6 py-3">ë‹´ë‹¹ì</th><th class="px-6 py-3">íˆ¬ì… MM</th><th class="px-6 py-3">1ì°¨ ê¸°ì—¬ë„ (%)</th><th class="px-6 py-3 text-center">ìƒì„¸ ì •ë³´</th></tr>`;
        } else if (viewType === 'manager') {
            tableHeader = `<tr><th class="px-6 py-3">ë‹´ë‹¹ì</th><th class="px-6 py-3">íˆ¬ì…MM</th><th class="px-6 py-3">1ì°¨ ê¸°ì—¬ë„(ì°¸ê³ )</th><th class="px-6 py-3">2ì°¨ ê¸°ì—¬ë„ (%)</th><th class="px-6 py-3 text-center">ìƒì„¸ ì •ë³´</th></tr>`;
        } else if (viewType === 'finalApprover') {
            tableHeader = `<tr><th class="px-6 py-3">ë‹´ë‹¹ì</th><th class="px-6 py-3">1ì°¨ ê¸°ì—¬ë„</th><th class="px-6 py-3">2ì°¨ ê¸°ì—¬ë„</th><th class="px-6 py-3">ê¸°ì—¬ë„ì„±ê³¼ê¸ˆ(ì°¸ê³ )</th><th class="px-6 py-3">ì‹¤ì§€ê¸‰ ì„±ê³¼ê¸ˆ(ë§Œì›)</th><th class="px-6 py-3 text-center">ìƒì„¸ ì •ë³´</th></tr>`;
        }
        
        let budgetSection = '';
        if(viewType === 'finalApprover') {
            const channelBudget = channelEvaluations[0] || {};
            budgetSection = `
                <div class="p-5 border-y border-gray-700">
                    <div class="grid grid-cols-12 gap-x-4 gap-y-2 items-end">
                        <div class="col-span-12 sm:col-span-6 md:col-span-2 flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-400">ì‚¬ì—…íš¨ìœ¨(%)</label>
                            <div class="relative">
                                <input type="number" value="${channelBudget['ì‚¬ì—…íš¨ìœ¨'] || 80}" class="w-full p-2 pr-6 rounded-md text-lg font-bold text-center efficiency-input input-field input-field-green">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">%</span>
                            </div>
                        </div>
                        <div class="col-span-12 sm:col-span-6 md:col-span-3 flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-400">1ì°¨ ì„±ê³¼ê¸ˆ(ë§Œì›)</label>
                            <input type="number" value="${channelBudget['íŒ€ì¥ì„±ê³¼ê¸ˆ'] || 500}" class="w-full p-2 rounded-md text-lg font-bold text-center incentive1-input input-field">
                        </div>
                        <div class="col-span-12 sm:col-span-6 md:col-span-3 flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-400">íŒ€ì¥ì„±ê³¼(%)</label>
                            <input type="number" value="${channelBudget['íŒ€ì¥ì„±ê³¼'] || 20}" class="w-full p-2 rounded-md text-lg font-bold text-center lead-perc-input input-field">
                        </div>
                        <div class="col-span-12 md:col-span-4 flex flex-col gap-1">
                            <h4 class="text-sm font-medium text-gray-400">2ì°¨ ì„±ê³¼ê¸ˆ (ë°°ë¶„ëŒ€ìƒ)</h4>
                            <div class="mt-1 p-2 rounded-md text-lg font-bold incentive-pool-field incentive2-output">400 ë§Œì›</div>
                            <div class="w-full mt-1 remaining-bar">
                                <div class="h-2 remaining-bar-fill incentive-progress-bar-fill" style="width: 0%;"></div>
                            </div>
                            <p class="text-xs text-right text-gray-400 incentive-ratio mt-1"></p>
                        </div>
                    </div>
                </div>`;
        }

        const membersHTML = members.map(member => {
            const evalData = channelEvaluations.find(e => e['ë‹´ë‹¹ìID'] === member['ì‚¬ìš©ìID']) || {};
            return createMemberRowHTML(member, channelId, viewType, evalData);
        }).join('');
        
        let footer = '';
        if (viewType === 'teamLead') {
            footer = `<tfoot class="font-semibold table-header"><tr><td class="px-6 py-3 text-right">í•©ê³„</td><td class="px-6 py-3 font-bold total-mm">0.0</td><td class="px-6 py-3 font-bold total-perc">0%</td><td><button class="add-member-btn text-indigo-300 hover:text-indigo-100 text-xs ml-4">+ ë‹´ë‹¹ì</button></td></tr></tfoot>`;
        } else if (viewType === 'manager') {
            footer = `<tfoot class="font-semibold table-header"><tr><td class="px-6 py-3 text-right" colspan="3">í•©ê³„</td><td class="px-6 py-3 font-bold total-perc">0%</td><td>${members.length === 0 ? '<button class="add-member-btn text-indigo-300 hover:text-indigo-100 text-xs ml-4">+ ë‹´ë‹¹ì</button>' : ''}</td></tr></tfoot>`;
        } else if (viewType === 'finalApprover') {
            footer = `<tfoot class="font-semibold table-header"><tr><td class="px-6 py-3 text-right" colspan="4">ì‹¤ì§€ê¸‰ í•©ê³„</td><td class="px-6 py-3 font-bold total-final-incentive">0 ë§Œì›</td><td>${members.length === 0 ? '<button class="add-member-btn text-indigo-300 hover:text-indigo-100 text-xs ml-4">+ ë‹´ë‹¹ì</button>' : ''}</td></tr></tfoot>`;
        }

        return `
            <div class="card rounded-lg shadow-md" data-channel-id="${channelId}">
                <div class="p-5">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <button class="toggle-channel-comment p-1 rounded-full hover:bg-gray-700"><i data-lucide="plus-circle"></i></button>
                            <h3 class="text-xl font-bold">${channelName}</h3>
                        </div>
                        <div class="dropdown">
                            <button class="toggle-menu p-1 rounded-full hover:bg-gray-600"><i data-lucide="more-vertical" class="w-4 h-4"></i></button>
                            <div class="dropdown-content">
                                <a class="remove-btn btn-danger">ì±„ë„ ì‚­ì œ</a>
                            </div>
                        </div>
                    </div>
                    ${viewType !== 'finalApprover' ? `
                    <div class="mt-3 text-sm text-gray-400">
                        <span>ì”ì—¬ ê¸°ì—¬ë„: </span>
                        <span class="font-bold text-lg text-green-400 remaining-perc">100%</span>
                        <div class="w-full mt-1 remaining-bar">
                            <div class="h-2 remaining-bar-fill" style="width: 0%;"></div>
                        </div>
                    </div>` : ''}
                </div>
                <div class="channel-comment-section hidden p-4 border-y border-gray-700 detail-section">
                    <h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="clipboard-edit"></i>ì±„ë„ ì¢…í•© ì½”ë©˜íŠ¸</h4>
                    <textarea class="w-full p-2 border rounded-md comment-textarea channel-comment" placeholder="ì±„ë„ ì „ì²´ì— ëŒ€í•œ ì¢…í•© ì½”ë©˜íŠ¸ë¥¼ ê¸°ë¡í•´ì£¼ì„¸ìš”.">${channelEvaluations[0]?.['ì±„ë„ì½”ë©˜íŠ¸'] || ''}</textarea>
                </div>
                ${budgetSection}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="table-header">${tableHeader}</thead>
                        <tbody class="member-list">${membersHTML}</tbody>
                        ${footer}
                    </table>
                </div>
            </div>`;
    }
    
    function createTeamCardHTML(team, viewType) {
        const teamId = team['íŒ€ID'];
        const teamName = team['íŒ€ì´ë¦„'];
        const teamChannels = appData.channels.filter(c => c['ì†Œì†íŒ€ID'] === teamId);
        
        const channelsHTML = teamChannels.map(channel => createChannelHTML(channel, viewType)).join('');
        
        return `
            <div class="card rounded-lg shadow-md" data-team-id="${teamId}">
                <div class="p-5 bg-gray-800 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold">${teamName}</h2>
                        <div class="dropdown">
                            <button class="toggle-menu p-1 rounded-full hover:bg-gray-600"><i data-lucide="more-vertical"></i></button>
                            <div class="dropdown-content">
                                <a class="remove-btn btn-danger">íŒ€ ì‚­ì œ</a>
                                <a class="add-channel-btn">ì±„ë„ ì¶”ê°€</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 space-y-8 channel-container">${channelsHTML}</div>
            </div>`;
    }

    function renderView(viewType) {
        const container = views[viewType];
        if (!container) return;
        
        let contentHTML = '';
        let footerHTML = '';

        if (viewType === 'teamLead') {
            const teamId = selectedTeamId || currentUser.ì†Œì†íŒ€ID.split(',')[0].trim();
            const userTeam = appData.teams.find(t => t['íŒ€ID'] === teamId);
            
            if (!userTeam) {
                contentHTML = '<p class="error-message">ì†Œì† íŒ€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                const teamChannels = appData.channels.filter(c => c['ì†Œì†íŒ€ID'] === userTeam['íŒ€ID']);
                const channelsHTML = teamChannels.map(channel => createChannelHTML(channel, 'teamLead')).join('');
                contentHTML = `
                    <h2 class="text-2xl font-semibold mb-4">${userTeam['íŒ€ì´ë¦„']} ì„±ê³¼ ì…ë ¥ (1ì°¨)</h2>
                    <div class="space-y-8 channel-container">${channelsHTML}</div>
                    <div class="mt-4">
                        <button class="add-channel-btn btn-secondary text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            <i data-lucide="plus"></i> ì±„ë„ ì¶”ê°€
                        </button>
                    </div>`;
                footerHTML = `
                    <button class="btn-secondary py-3 px-6 text-base rounded-lg save-draft-btn">ì„ì‹œ ì €ì¥</button>
                    <button class="btn-primary py-3 px-6 text-base rounded-lg submit-evaluation-btn">1ì°¨ í‰ê°€ ìµœì¢… ì œì¶œ</button>`;
            }
        } else {
            const teamCardsHTML = appData.teams.map(team => createTeamCardHTML(team, viewType)).join('');
            const title = viewType === 'manager' ? 'ì „ì²´ ì„±ê³¼ ì·¨í•© (2ì°¨)' : 'ìµœì¢… ì„±ê³¼ê¸ˆ ì…ë ¥ (3ì°¨)';
            const buttons = viewType === 'finalApprover' ? 
                `<button class="btn-secondary py-3 px-6 text-base rounded-lg save-draft-btn">ì €ì¥í•˜ê¸°</button>
                 <button class="btn-primary py-3 px-6 text-base rounded-lg submit-evaluation-btn">ì´ë‹¬ì˜ í‰ê°€ ìµœì¢… í™•ì •</button>` : 
                `<button class="btn-primary py-3 px-6 text-base rounded-lg submit-evaluation-btn">2ì°¨ í‰ê°€ ì €ì¥</button>`;
            
            contentHTML = `
                <h2 class="text-2xl font-semibold mb-4">${title}</h2>
                <div class="space-y-8" id="${viewType}-cards">${teamCardsHTML}</div>
                <div class="mt-4 flex gap-4">
                    <button class="add-team-btn btn-secondary text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="plus"></i> íŒ€ ì¶”ê°€
                    </button>
                    ${viewType === 'finalApprover' ? `
                    <button class="add-admin-btn btn-secondary text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="user-plus"></i> ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€
                    </button>` : ''}
                </div>`;
            footerHTML = buttons;
        }
        
        container.innerHTML = contentHTML;
        document.getElementById('footer-buttons').innerHTML = footerHTML;
        
        initCalculations(container);
        lucide.createIcons();
    }

    // Undo ê¸°ëŠ¥
    function showUndoToast(message, elementToRemove) {
        clearTimeout(undoState.timer);
        const toast = document.getElementById('undo-toast');
        document.getElementById('undo-message').textContent = message;

        undoState.element = elementToRemove;
        undoState.parent = elementToRemove.parentNode;
        undoState.nextSibling = elementToRemove.nextElementSibling;
        
        elementToRemove.style.display = 'none';
        toast.classList.add('show');
        
        undoState.timer = setTimeout(() => {
            if (undoState.element && undoState.element.parentNode) {
                undoState.element.remove();
            }
            hideUndoToast();
        }, 5000);
    }

    function hideUndoToast() {
        const toast = document.getElementById('undo-toast');
        toast.classList.remove('show');
        clearTimeout(undoState.timer);
        undoState = { timer: null, element: null, parent: null, nextSibling: null };
    }

    // ì´ë²¤íŠ¸ ìœ„ì„
    document.getElementById('main-screen').addEventListener('click', (e) => {
        const target = e.target;

        // ë“œë¡­ë‹¤ìš´ ë©”ë‰´
        const menuBtn = target.closest('.toggle-menu');
        if (menuBtn) {
            e.preventDefault();
            const dropdownContent = menuBtn.nextElementSibling;
            document.querySelectorAll('.dropdown-content.show').forEach(d => {
                if (d !== dropdownContent) d.classList.remove('show');
            });
            dropdownContent.classList.toggle('show');
            return;
        }
        if (!target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-content.show').forEach(d => d.classList.remove('show'));
        }

        // ì‚­ì œ ë²„íŠ¼
        if (target.closest('.remove-btn')) {
            e.preventDefault();
            let elementToRemove;
            let message = "í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";

            const memberRow = target.closest('tr.table-row');
            if (memberRow) {
                elementToRemove = memberRow;
                const commentRow = memberRow.nextElementSibling;
                if (commentRow && commentRow.classList.contains('comment-row')) {
                    commentRow.remove();
                }
                message = `${memberRow.dataset.memberName} ë‹˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;
            } else {
                const card = target.closest('.card[data-channel-id]') || target.closest('.card[data-team-id]');
                if (card) {
                    elementToRemove = card;
                    message = card.dataset.channelId ? "ì±„ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤." : "íŒ€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
                }
            }
            
            if (elementToRemove) {
                showUndoToast(message, elementToRemove);
                target.closest('.dropdown-content').classList.remove('show');
            }
            return;
        }

        // ì½”ë©˜íŠ¸ í† ê¸€
        const toggleBtn = target.closest('.toggle-comment, .toggle-channel-comment');
        if (toggleBtn) {
            e.preventDefault();
            const isMemberComment = toggleBtn.classList.contains('toggle-comment');
            const section = isMemberComment 
                ? toggleBtn.closest('tr').nextElementSibling 
                : toggleBtn.closest('.card').querySelector('.channel-comment-section');
            
            section.classList.toggle('hidden');
            toggleBtn.innerHTML = section.classList.contains('hidden') ? '<i data-lucide="plus-circle"></i>' : '<i data-lucide="minus-circle"></i>';
            lucide.createIcons();
            return;
        }

        // ì„±ê³¼ í•­ëª© ì¶”ê°€
        if (target.closest('.add-performance-btn')) {
            e.preventDefault();
            const container = target.closest('.core-performance-container');
            const newItem = document.createElement('div');
            newItem.className = 'grid grid-cols-5 gap-2 items-center performance-item';
            newItem.innerHTML = `
                <input type="text" placeholder="ì˜ˆ: ìµœê³  ì¡°íšŒìˆ˜ ì˜ìƒ" class="col-span-2 bg-gray-800 rounded p-1 performance-title">
                <input type="text" placeholder="ì˜ˆ: ìš°ì£¼ë‹¤í (230ë§Œ)" class="col-span-3 bg-gray-800 rounded p-1 performance-value">`;
            container.insertBefore(newItem, target);
            return;
        }

        // ë‹´ë‹¹ì ì¶”ê°€
        if (target.closest('.add-member-btn')) {
            e.preventDefault();
            const channelCard = target.closest('.card[data-channel-id]');
            const channelId = channelCard.dataset.channelId;
            const channel = appData.channels.find(c => c['ì±„ë„ID'] === channelId);
            const teamId = channel ? channel['ì†Œì†íŒ€ID'] : null;
            openAddMemberModal(channelId, teamId);
            return;
        }

        // ì±„ë„ ì¶”ê°€
        if (target.closest('.add-channel-btn')) {
            const teamCard = target.closest('.card[data-team-id]');
            const teamId = teamCard ? teamCard.dataset.teamId : (selectedTeamId || currentUser.ì†Œì†íŒ€ID.split(',')[0].trim());
            const channelName = prompt('ìƒˆ ì±„ë„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (channelName) {
                showLoading();
                google.script.run
                    .withSuccessHandler(result => {
                        if (result.success) {
                            showSuccess('ì±„ë„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            const roleMap = {
                                'teamLead': 'íŒ€ì¥',
                                'manager': 'ê´€ë¦¬ì',
                                'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
                            };
                            loadData(roleMap[currentRole]);
                        } else {
                            showError(result.message);
                            hideLoading();
                        }
                    })
                    .withFailureHandler(error => {
                        showError('ì±„ë„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        hideLoading();
                    })
                    .addChannel({ name: channelName, teamId: teamId });
            }
            return;
        }

        // íŒ€ ì¶”ê°€
        if (target.closest('.add-team-btn')) {
            const teamName = prompt('ìƒˆ íŒ€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (teamName) {
                showLoading();
                google.script.run
                    .withSuccessHandler(result => {
                        if (result.success) {
                            showSuccess('íŒ€ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            const roleMap = {
                                'teamLead': 'íŒ€ì¥',
                                'manager': 'ê´€ë¦¬ì',
                                'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
                            };
                            loadData(roleMap[currentRole]);
                        } else {
                            showError(result.message);
                            hideLoading();
                        }
                    })
                    .withFailureHandler(error => {
                        showError('íŒ€ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        hideLoading();
                    })
                    .addTeam({ name: teamName });
            }
            return;
        }

        // ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€
        if (target.closest('.add-admin-btn')) {
            e.preventDefault();
            openAddAdminModal();
            return;
        }
    });

    // footer ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('action-footer').addEventListener('click', (e) => {
        const target = e.target;
        
        if (target.closest('.save-draft-btn, .submit-evaluation-btn')) {
            e.preventDefault();
            const isDraft = target.closest('.save-draft-btn') !== null;
            collectAndSaveData(isDraft);
            return;
        }
    });

    // ê³„ì‚° ë¡œì§ ì´ˆê¸°í™”
    function initCalculations(scopeElement) {
        if (!scopeElement) return;

        const cards = scopeElement.matches('.card[data-channel-id]') ? [scopeElement] : scopeElement.querySelectorAll('.card[data-channel-id]');
        
        cards.forEach(card => {
            const calculate = () => {
                // ê¸°ì—¬ë„ ê³„ì‚°
                const percInputs = card.querySelectorAll('.perc-input');
                if (percInputs.length > 0) {
                    let totalPerc = 0;
                    percInputs.forEach(input => { 
                        totalPerc += parseFloat(input.value) || 0; 
                    });
                    
                    const remaining = 100 - totalPerc;
                    const remainingEl = card.querySelector('.remaining-perc');
                    if (remainingEl) {
                        remainingEl.textContent = `${remaining}%`;
                        remainingEl.classList.toggle('text-red-500', remaining < 0);
                        remainingEl.classList.toggle('text-green-400', remaining >= 0);
                    }
                    const remainingBarFill = card.querySelector('.remaining-bar-fill');
                    if(remainingBarFill) {
                        remainingBarFill.style.width = `${Math.min(100, totalPerc)}%`;
                        remainingBarFill.classList.toggle('over', totalPerc > 100);
                    }
                    
                    const totalPercEl = card.querySelector('.total-perc');
                    if (totalPercEl) totalPercEl.textContent = `${totalPerc}%`;
                }
                
                // MM ê³„ì‚°
                const mmInputs = card.querySelectorAll('.mm-input');
                if (mmInputs.length > 0) {
                    let totalMM = 0; 
                    mmInputs.forEach(input => { 
                        totalMM += parseFloat(input.value) || 0; 
                    });
                    const totalMMEl = card.querySelector('.total-mm');
                    if (totalMMEl) totalMMEl.textContent = totalMM.toFixed(1);
                }
                
                // ìµœì¢… ì„±ê³¼ê¸ˆ ê³„ì‚°
                if (card.querySelector('.incentive1-input')) {
                    const incentive1 = parseFloat(card.querySelector('.incentive1-input').value) || 0;
                    const leadPerc = (parseFloat(card.querySelector('.lead-perc-input').value) || 0) / 100;
                    const incentive2ForDistribution = incentive1 * (1 - leadPerc);

                    let totalManualPaid = 0;
                    card.querySelectorAll('.final-incentive-input').forEach(input => {
                        totalManualPaid += parseFloat(input.value) || 0;
                    });
                    
                    const totalFinalIncentiveEl = card.querySelector('.total-final-incentive');
                    if(totalFinalIncentiveEl) {
                        totalFinalIncentiveEl.textContent = `${formatCurrency(totalManualPaid)} ë§Œì›`;
                    }

                    const incentive2OutputEl = card.querySelector('.incentive2-output');
                    if(incentive2OutputEl) {
                        incentive2OutputEl.textContent = `${formatCurrency(incentive2ForDistribution.toFixed(0))} ë§Œì›`;
                    }
                    
                    const incentiveRatioEl = card.querySelector('.incentive-ratio');
                    if(incentiveRatioEl) {
                        const ratio = incentive2ForDistribution > 0 ? (totalManualPaid / incentive2ForDistribution * 100) : 0;
                        incentiveRatioEl.textContent = `${formatCurrency(totalManualPaid)} / ${formatCurrency(incentive2ForDistribution.toFixed(0))} ë§Œì› (${ratio.toFixed(0)}%)`;
                        incentiveRatioEl.classList.toggle('text-red-400', ratio > 100);
                    }

                    const progressPercentage = incentive2ForDistribution > 0 ? (totalManualPaid / incentive2ForDistribution) * 100 : 0;
                    const incentiveProgressBar = card.querySelector('.incentive-progress-bar-fill');
                    if(incentiveProgressBar) {
                        incentiveProgressBar.style.width = `${Math.min(100, progressPercentage)}%`;
                        incentiveProgressBar.classList.toggle('over', progressPercentage > 100);
                    }

                    // ìë™ ê³„ì‚°ëœ ê¸°ì—¬ë„ ì„±ê³¼ê¸ˆ
                    let totalContribution = 0;
                    const memberRows = card.querySelectorAll('tr[data-member-name]');
                    memberRows.forEach(row => {
                        const cell = row.cells[2];
                        if(cell) {
                            const text = cell.textContent.replace('%', '');
                            totalContribution += parseFloat(text) || 0;
                        }
                    });

                    memberRows.forEach(row => {
                        const contributionCell = row.cells[2];
                        if(contributionCell) {
                            const contributionText = contributionCell.textContent.replace('%', '');
                            const contribution = parseFloat(contributionText) || 0;
                            const autoCalculatedIncentive = totalContribution > 0 ? (contribution / totalContribution) * incentive2ForDistribution : 0;
                            const incentiveDiv = row.querySelector('.contribution-incentive');
                            if (incentiveDiv) {
                                incentiveDiv.textContent = `${formatCurrency(autoCalculatedIncentive.toFixed(0))} ë§Œì›`;
                            }
                        }
                    });
                }
            };

            card.addEventListener('input', e => {
                if (e.target.matches('.perc-input, .mm-input, .incentive1-input, .lead-perc-input, .final-incentive-input')) {
                    calculate();
                }
            });
            calculate();
        });
    }

    // ë°ì´í„° ìˆ˜ì§‘ ë° ì €ì¥
    function collectAndSaveData(isDraft = false) {
        const evaluations = [];
        
        document.querySelectorAll('.card[data-channel-id]').forEach(channelCard => {
            const channelId = channelCard.dataset.channelId;
            const channelComment = channelCard.querySelector('.channel-comment')?.value || '';
            
            let channelBudget = {};
            if (currentRole === 'finalApprover') {
                channelBudget = {
                    ì‚¬ì—…íš¨ìœ¨: parseFloat(channelCard.querySelector('.efficiency-input')?.value) || 80,
                    íŒ€ì¥ì„±ê³¼ê¸ˆ: parseFloat(channelCard.querySelector('.incentive1-input')?.value) || 0,
                    íŒ€ì¥ì„±ê³¼: parseFloat(channelCard.querySelector('.lead-perc-input')?.value) || 0
                };
            }
            
            channelCard.querySelectorAll('tr[data-member-id]').forEach(memberRow => {
                const memberId = memberRow.dataset.memberId;
                const memberName = memberRow.dataset.memberName;
                
                let evalData = appData.evaluations.find(e => 
                    e['ì±„ë„ID'] === channelId && 
                    e['ë‹´ë‹¹ìID'] === memberId && 
                    e['í‰ê°€ì›”'] === currentMonth
                );
                
                if (!evalData) {
                    evalData = {
                        í‰ê°€ID: null,
                        í‰ê°€ì›”: currentMonth,
                        ì±„ë„ID: channelId,
                        ë‹´ë‹¹ìID: memberId,
                        ë‹´ë‹¹ìì´ë¦„: memberName
                    };
                } else {
                    evalData = { ...evalData };
                }
                
                if (currentRole === 'teamLead') {
                    evalData['íˆ¬ì…MM'] = parseFloat(memberRow.querySelector('.mm-input')?.value) || 0;
                    evalData['1ì°¨ê¸°ì—¬ë„'] = parseFloat(memberRow.querySelector('.perc-input')?.value) || 0;
                    
                    const commentRow = memberRow.nextElementSibling;
                    if (commentRow) {
                        const performances = [];
                        commentRow.querySelectorAll('.performance-item').forEach(item => {
                            const title = item.querySelector('.performance-title')?.value;
                            const value = item.querySelector('.performance-value')?.value;
                            if (title || value) {
                                performances.push(`${title}|${value}`);
                            }
                        });
                        evalData['1ì°¨ì„±ê³¼ë‚´ìš©'] = performances.join('||');
                        evalData['1ì°¨ì½”ë©˜íŠ¸'] = commentRow.querySelector('.comment-1')?.value || '';
                    }
                    evalData['1ì°¨í‰ê°€ìƒíƒœ'] = isDraft ? 'ì„ì‹œì €ì¥' : 'ì œì¶œì™„ë£Œ';
                } else if (currentRole === 'manager') {
                    evalData['2ì°¨ê¸°ì—¬ë„'] = parseFloat(memberRow.querySelector('.perc-input')?.value) || 0;
                    
                    const commentRow = memberRow.nextElementSibling;
                    if (commentRow) {
                        evalData['2ì°¨ì½”ë©˜íŠ¸'] = commentRow.querySelector('.comment-2')?.value || '';
                    }
                    evalData['2ì°¨í‰ê°€ìƒíƒœ'] = isDraft ? 'ì„ì‹œì €ì¥' : 'ì œì¶œì™„ë£Œ';
                } else if (currentRole === 'finalApprover') {
                    evalData['ì‹¤ì§€ê¸‰ì„±ê³¼ê¸ˆ'] = parseFloat(memberRow.querySelector('.final-incentive-input')?.value) || 0;
                    evalData['ì‚¬ì—…íš¨ìœ¨'] = channelBudget.ì‚¬ì—…íš¨ìœ¨;
                    evalData['íŒ€ì¥ì„±ê³¼ê¸ˆ'] = channelBudget.íŒ€ì¥ì„±ê³¼ê¸ˆ;
                    evalData['íŒ€ì¥ì„±ê³¼'] = channelBudget.íŒ€ì¥ì„±ê³¼;
                    
                    const commentRow = memberRow.nextElementSibling;
                    if (commentRow) {
                        evalData['ìµœì¢…ì½”ë©˜íŠ¸'] = commentRow.querySelector('.comment-final')?.value || '';
                    }
                    evalData['ìµœì¢…í‰ê°€ìƒíƒœ'] = isDraft ? 'ì„ì‹œì €ì¥' : 'ì œì¶œì™„ë£Œ';
                }
                
                evalData['ì±„ë„ì½”ë©˜íŠ¸'] = channelComment;
                evalData['ë‹´ë‹¹ìì´ë¦„'] = memberName;
                evaluations.push(evalData);
            });
        });
        
        if (evaluations.length > 0) {
            saveEvaluationData(evaluations, isDraft);
        } else {
            showError('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ì—­í•  ì „í™˜
    function switchView(role) {
        if (!currentUser) return;
        
        const roleMap = {
            'teamLead': 'íŒ€ì¥',
            'manager': 'ê´€ë¦¬ì', 
            'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
        };
        
        const permissionMap = {
            'teamLead': '1ì°¨',
            'manager': '2ì°¨',
            'finalApprover': '3ì°¨'
        };
        
        if (!currentUser.í‰ê°€ê¶Œí•œ || !currentUser.í‰ê°€ê¶Œí•œ.includes(permissionMap[role])) {
            showError(`${roleMap[role]} í‰ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        
        currentRole = role;
        
        Object.values(views).forEach(view => { 
            if (view) view.classList.add('hidden'); 
        });
        
        Object.values(buttons).forEach(btn => { 
            if (btn) {
                btn.classList.remove('btn-primary'); 
                btn.classList.add('btn-secondary'); 
            }
        });
        
        buttons[role].classList.remove('btn-secondary');
        buttons[role].classList.add('btn-primary');
        
        document.getElementById('user-info').textContent = `${currentUser.ì´ë¦„}ë‹˜ (${roleMap[role]})`;
        
        loadData(roleMap[role]);
    }

    // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', function() {
        initializeDOMReferences();
        
        // ì„¸ì…˜ í™•ì¸ - ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€
        checkUserSession();
        
        // ë¡œê·¸ì¸ í¼ ì´ë²¤íŠ¸
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        
        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        
        // ì—­í•  ì „í™˜ ë²„íŠ¼ ì´ë²¤íŠ¸
        buttons.teamLead.addEventListener('click', () => {
            if (currentUser && !buttons.teamLead.disabled) switchView('teamLead');
        });
        buttons.manager.addEventListener('click', () => {
            if (currentUser && !buttons.manager.disabled) switchView('manager');
        });
        buttons.finalApprover.addEventListener('click', () => {
            if (currentUser && !buttons.finalApprover.disabled) switchView('finalApprover');
        });
        
        // ì›” ì„ íƒ ì´ë²¤íŠ¸
        document.getElementById('evaluation-month-select').addEventListener('change', (e) => {
            currentMonth = e.target.value;
            if (currentMonth && currentRole && currentUser) {
                const roleMap = {
                    'teamLead': 'íŒ€ì¥',
                    'manager': 'ê´€ë¦¬ì',
                    'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
                };
                loadData(roleMap[currentRole]);
            }
        });
        
        // íŒ€ ì„ íƒ ì´ë²¤íŠ¸
        document.getElementById('team-select').addEventListener('change', (e) => {
            selectedTeamId = e.target.value;
            if (selectedTeamId && currentRole === 'teamLead') {
                loadData('íŒ€ì¥');
            }
        });
        
        // Undo ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('undo-btn').addEventListener('click', () => {
            if (undoState.element) {
                undoState.element.style.display = '';
                hideUndoToast();
            }
        });
        
        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        document.querySelector('.close').addEventListener('click', closeAddMemberModal);
        document.querySelector('#addAdminModal .close').addEventListener('click', closeAddAdminModal);
        
        // ëª¨ë‹¬ ë°– í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', (event) => {
            const modal1 = document.getElementById('addMemberModal');
            const modal2 = document.getElementById('addAdminModal');
            if (event.target === modal1) {
                closeAddMemberModal();
            } else if (event.target === modal2) {
                closeAddAdminModal();
            }
        });

        // ê´€ë¦¬ì ì—­í•  ì„ íƒ ì‹œ ê¸°ë³¸ ê¶Œí•œ ìë™ ì„¤ì •
        document.getElementById('adminRole').addEventListener('change', (e) => {
            const role = e.target.value;
            document.getElementById('adminPerm1').checked = role === 'íŒ€ì¥';
            document.getElementById('adminPerm2').checked = role === 'ê´€ë¦¬ì';
            document.getElementById('adminPerm3').checked = role === 'ìµœì¢…ê´€ë¦¬ì';
        });
        
        // ë‹´ë‹¹ì ì¶”ê°€ í¼ ì œì¶œ
        document.getElementById('addMemberForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const userData = {
                name: document.getElementById('newMemberName').value,
                role: document.getElementById('newMemberRole').value,
                teamId: pendingMemberData.teamId
            };
            
            // ë¡œë”© í‘œì‹œ ëŒ€ì‹  ë²„íŠ¼ë§Œ ë¹„í™œì„±í™”
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì¶”ê°€ ì¤‘...';
            
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        showSuccess('ë‹´ë‹¹ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        closeAddMemberModal();
                        
                        // í™”ë©´ì— ì¦‰ì‹œ ì¶”ê°€ (ë°ì´í„° ë¦¬ë¡œë“œ ì—†ì´)
                        const channelCard = document.querySelector(`[data-channel-id="${pendingMemberData.channelId}"]`);
                        if (channelCard && result.member) {
                            // appDataì— ì¶”ê°€
                            appData.members.push(result.member);
                            
                            // í™”ë©´ì— ë°”ë¡œ ë Œë”ë§
                            addMemberToChannel(channelCard, result.member, pendingMemberData.channelId);
                        }
                    } else {
                        showError(result.message);
                    }
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ì¶”ê°€';
                })
                .withFailureHandler(error => {
                    showError('ë‹´ë‹¹ì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ì¶”ê°€';
                })
                .addMember(userData);  // addUser ëŒ€ì‹  addMember í˜¸ì¶œ
        });

        // ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€ í¼ ì œì¶œ
        document.getElementById('addAdminForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const teamSelect = document.getElementById('adminTeam');
            const selectedTeams = Array.from(teamSelect.selectedOptions).map(opt => opt.value);
            
            const adminData = {
                userId: document.getElementById('adminEmail').value,
                name: document.getElementById('adminName').value,
                password: document.getElementById('adminPassword').value,
                role: document.getElementById('adminRole').value,
                teamId: selectedTeams.join(','),
                permissions: {
                    perm1: document.getElementById('adminPerm1').checked,
                    perm2: document.getElementById('adminPerm2').checked,
                    perm3: document.getElementById('adminPerm3').checked
                }
            };
            
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        showSuccess('ì‹œìŠ¤í…œ ê´€ë¦¬ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        closeAddAdminModal();
                        const roleMap = {
                            'teamLead': 'íŒ€ì¥',
                            'manager': 'ê´€ë¦¬ì',
                            'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
                        };
                        loadData(roleMap[currentRole]);
                    } else {
                        showError(result.message);
                    }
                    hideLoading();
                })
                .withFailureHandler(error => {
                    showError('ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    hideLoading();
                })
                .addUser(adminData);
        });
    });
    </script>
</body>
</html>
