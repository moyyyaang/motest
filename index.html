<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; background-color: #111827; color: #F9FAFB; }
        .card { background-color: #1F2937; border: 1px solid #374151; }
        .table-header { background-color: #374151; }
        .table-row:not(.comment-row):hover { background-color: #374151; }
        .btn-primary { background-color: #4F46E5; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338CA; }
        .btn-secondary { background-color: #4B5563; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #6B7280; }
        .btn-danger { color: #FCA5A5; }
        .btn-danger:hover { color: #F87171; }
        .comment-textarea { background-color: #111827; border-color: #4B5563; resize: vertical; min-height: 80px; }
        .remaining-bar { background-color: #374151; border-radius: 6px; overflow: hidden; }
        .remaining-bar-fill { background-color: #4F46E5; transition: width 0.3s ease-in-out; }
        .remaining-bar-fill.over { background-color: #EF4444; }
        .detail-section { background-color: #121A2A; }
        .input-field { background-color: #374151; }
        .input-field-green { background-color: #052e16; color: #a7f3d0; border-color: #34d399; }
        .readonly-field { background-color: #1F2937; color: #D1D5DB; border: 1px solid transparent; user-select: none; }
        .incentive-pool-field { background-color: #1e1b4b; color: #c7d2fe; border: 1px solid #4f46e5;}
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: #374151; min-width: 100px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 10; border-radius: 4px; }
        .dropdown-content a { color: #F9FAFB; padding: 8px 12px; text-decoration: none; display: block; font-size: 12px; cursor: pointer; }
        .dropdown-content a:hover { background-color: #4B5563; }
        .show { display: block; }
        #undo-toast { visibility: hidden; min-width: 250px; background-color: #1F2937; border: 1px solid #374151; color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 50; left: 50%; transform: translateX(-50%); bottom: 30px; transition: visibility 0.5s, opacity 0.5s linear; opacity: 0; }
        #undo-toast.show { visibility: visible; opacity: 1; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .error-message {
            background-color: #991b1b;
            border: 1px solid #dc2626;
            color: #fecaca;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .success-message {
            background-color: #14532d;
            border: 1px solid #16a34a;
            color: #bbf7d0;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #1F2937;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #374151;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #fff;
        }
        /* í‰ê°€ì§„í–‰ìƒíƒœ ìŠ¤íƒ€ì¼ */
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .status-ë¯¸ì‹œì‘ { background-color: #374151; color: #9CA3AF; }
        .status-1ì°¨ì§„í–‰ì¤‘ { background-color: #1E40AF; color: #93BBFC; }
        .status-2ì°¨ëŒ€ê¸° { background-color: #7C3AED; color: #DDD6FE; }
        .status-3ì°¨ëŒ€ê¸° { background-color: #DB2777; color: #FBCFE8; }
        .status-ì™„ë£Œ { background-color: #059669; color: #A7F3D0; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto" id="main-container">
        <header class="mb-8">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h1 class="text-3xl font-bold">ğŸš€ ì„±ê³¼ í‰ê°€ ì‹œìŠ¤í…œ</h1>
                <div class="flex items-center gap-3 p-2 rounded-lg card">
                    <span class="text-sm font-medium">ì—­í•  ì „í™˜:</span>
                    <div class="flex gap-2">
                        <button id="btn-team-lead" class="btn-primary text-white font-bold py-2 px-3 rounded-lg text-sm">íŒ€ì¥</button>
                        <button id="btn-manager" class="btn-secondary text-white font-bold py-2 px-3 rounded-lg text-sm">ê´€ë¦¬ì</button>
                        <button id="btn-final-approver" class="btn-secondary text-white font-bold py-2 px-3 rounded-lg text-sm">ìµœì¢…ê´€ë¦¬ì</button>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex flex-wrap justify-between items-center gap-4">
                 <div class="flex items-center gap-3">
                     <span class="font-semibold text-lg" id="user-info"></span>
                     <a href="#" class="text-sm text-gray-400 hover:text-indigo-400">ë¡œê·¸ì•„ì›ƒ</a>
                 </div>
                 <div class="flex items-center gap-4">
                     <div class="flex items-center gap-2" id="team-selector" style="display: none;">
                         <i data-lucide="users" class="w-5 h-5 text-gray-400"></i>
                         <select id="team-select" class="card p-2 rounded-md border-0 focus:ring-2 focus:ring-indigo-500">
                             <option value="">íŒ€ ì„ íƒ...</option>
                         </select>
                     </div>
                     <div class="flex items-center gap-2">
                         <i data-lucide="calendar" class="w-5 h-5 text-gray-400"></i>
                         <select id="evaluation-month-select" class="card p-2 rounded-md border-0 focus:ring-2 focus:ring-indigo-500">
                             <option value="">ì›” ì„ íƒ...</option>
                         </select>
                     </div>
                 </div>
            </div>
        </header>

        <main class="pb-20">
            <div id="loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                <p class="mt-4 text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <div id="team-lead-view"></div>
            <div id="manager-view" class="hidden"></div>
            <div id="final-approver-view" class="hidden"></div>
        </main>
    </div>
    
    <footer id="action-footer" class="fixed bottom-0 left-0 right-0 bg-gray-900/80 backdrop-blur-sm border-t border-gray-700">
        <div class="max-w-7xl mx-auto p-4 flex justify-end gap-3" id="footer-buttons">
            <!-- Buttons will be rendered here -->
        </div>
    </footer>

    <div id="undo-toast"><span id="undo-message"></span><button id="undo-btn" class="ml-4 text-indigo-400 font-bold">ì‹¤í–‰ ì·¨ì†Œ</button></div>

    <!-- ë‹´ë‹¹ì ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-xl font-bold mb-4">ìƒˆ ë‹´ë‹¹ì ì¶”ê°€</h2>
            <form id="addMemberForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ì´ë¦„</label>
                    <input type="text" id="newMemberName" class="w-full p-2 rounded-md input-field" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ì—­í• </label>
                    <select id="newMemberRole" class="w-full p-2 rounded-md input-field" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="PD">PD</option>
                        <option value="í¸ì§‘ì">í¸ì§‘ì</option>
                        <option value="ì‘ê°€">ì‘ê°€</option>
                        <option value="ë””ìì´ë„ˆ">ë””ìì´ë„ˆ</option>
                        <option value="ê°œë°œì">ê°œë°œì</option>
                    </select>
                </div>
                <div class="flex justify-between mt-6">
                    <button type="button" class="btn-secondary px-4 py-2 rounded-lg" onclick="closeAddMemberModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-white">ì¶”ê°€</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addAdminModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddAdminModal()">&times;</span>
            <h2 class="text-xl font-bold mb-4">ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€</h2>
            <form id="addAdminForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ì´ë¦„</label>
                    <input type="text" id="adminName" class="w-full p-2 rounded-md input-field" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ì´ë©”ì¼ (ë¡œê·¸ì¸ ID)</label>
                    <input type="email" id="adminEmail" class="w-full p-2 rounded-md input-field" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ì†Œì†íŒ€</label>
                    <select id="adminTeam" class="w-full p-2 rounded-md input-field" multiple size="3">
                        <!-- íŒ€ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Ctrl+í´ë¦­ìœ¼ë¡œ ì—¬ëŸ¬ íŒ€ ì„ íƒ ê°€ëŠ¥</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">ê´€ë¦¬ ì—­í• </label>
                    <select id="adminRole" class="w-full p-2 rounded-md input-field" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="íŒ€ì¥">íŒ€ì¥</option>
                        <option value="ê´€ë¦¬ì">ê´€ë¦¬ì</option>
                        <option value="ìµœì¢…ê´€ë¦¬ì">ìµœì¢…ê´€ë¦¬ì</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">í‰ê°€ ê¶Œí•œ</label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="adminPerm1" class="mr-2">
                            <span>1ì°¨ í‰ê°€</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="adminPerm2" class="mr-2">
                            <span>2ì°¨ í‰ê°€</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="adminPerm3" class="mr-2">
                            <span>3ì°¨ í‰ê°€</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button type="button" class="btn-secondary px-4 py-2 rounded-lg" onclick="closeAddAdminModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-white">ì¶”ê°€</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
    // ì „ì—­ ìƒíƒœ ê´€ë¦¬ - ì´ˆê¸°ê°’ë§Œ ì„¤ì •
    let currentUser = null;
    let currentRole = null;
    let currentMonth = null;
    let selectedTeamId = null; // ì„ íƒëœ íŒ€ ID (íŒ€ì¥ì¼ ë•Œ)
    let appData = {
        teams: [],
        channels: [],
        evaluations: [],
        users: [],
        members: []  // ë‹´ë‹¹ì ë°ì´í„° ì¶”ê°€
    };
    let evaluationStatus = {
        channelStatus: {},
        teamStatus: {}
    };

    // DOM ìš”ì†Œ ì°¸ì¡° ë³€ìˆ˜ë“¤
    let views = {};
    let buttons = {};
    let userInfoEl = null;
    let actionFooter = null;
    let loadingEl = null;
    let monthSelect = null;
    let teamSelect = null;
    let teamSelector = null;
    
    const formatCurrency = (num) => new Intl.NumberFormat('ko-KR').format(num);
    let undoState = { timer: null, element: null, parent: null, nextSibling: null };
    
    // ì„ì‹œ ë³€ìˆ˜ - ë‹´ë‹¹ì ì¶”ê°€ ì‹œ ì‚¬ìš©
    let pendingMemberData = null;

    // DOM ìš”ì†Œ ì´ˆê¸°í™” í•¨ìˆ˜
    function initializeDOMReferences() {
        console.log('DOM ì°¸ì¡° ì´ˆê¸°í™” ì‹œì‘');
        views = { 
            teamLead: document.getElementById('team-lead-view'), 
            manager: document.getElementById('manager-view'), 
            finalApprover: document.getElementById('final-approver-view') 
        };
        buttons = { 
            teamLead: document.getElementById('btn-team-lead'), 
            manager: document.getElementById('btn-manager'), 
            finalApprover: document.getElementById('btn-final-approver') 
        };
        userInfoEl = document.getElementById('user-info');
        actionFooter = document.getElementById('footer-buttons');
        loadingEl = document.getElementById('loading');
        monthSelect = document.getElementById('evaluation-month-select');
        teamSelect = document.getElementById('team-select');
        teamSelector = document.getElementById('team-selector');
        
        console.log('ì´ˆê¸°í™”ëœ views:', views);
        console.log('ê° viewì˜ ìƒíƒœ:', {
            teamLead: views.teamLead ? 'OK' : 'NOT FOUND',
            manager: views.manager ? 'OK' : 'NOT FOUND',
            finalApprover: views.finalApprover ? 'OK' : 'NOT FOUND'
        });
    }

    // Google Apps Script í†µì‹  í•¨ìˆ˜ë“¤
    function showLoading() {
        const loading = document.getElementById('loading');
        if (loading) {
            loading.classList.remove('hidden');
        }
        // ëª¨ë“  ë·° ìˆ¨ê¸°ê¸°
        const allViews = ['team-lead-view', 'manager-view', 'final-approver-view'];
        allViews.forEach(viewId => {
            const view = document.getElementById(viewId);
            if (view) view.classList.add('hidden');
        });
    }

    function hideLoading() {
        console.log('hideLoading í˜¸ì¶œë¨');
        const loading = document.getElementById('loading');
        if (loading) {
            loading.classList.add('hidden');
            console.log('ë¡œë”© í™”ë©´ ìˆ¨ê¹€');
        } else {
            console.error('ë¡œë”© ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        }
        
        // í˜„ì¬ í™œì„± ë·° í‘œì‹œ
        if (currentRole && views[currentRole]) {
            views[currentRole].classList.remove('hidden');
            console.log(currentRole + ' ë·° í‘œì‹œ');
        }
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = 'ì˜¤ë¥˜: ' + message;
        document.getElementById('main-container').prepend(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
    }

    function showSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = message;
        document.getElementById('main-container').prepend(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
    }

    // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
    function openAddMemberModal(channelId, teamId) {
        pendingMemberData = { channelId, teamId };
        document.getElementById('addMemberModal').style.display = 'block';
        document.getElementById('newMemberName').value = '';
        document.getElementById('newMemberRole').value = '';
    }

    function closeAddMemberModal() {
        document.getElementById('addMemberModal').style.display = 'none';
        pendingMemberData = null;
    }

    function openAddAdminModal() {
        document.getElementById('addAdminModal').style.display = 'block';
        // íŒ€ ëª©ë¡ ì—…ë°ì´íŠ¸
        const teamSelect = document.getElementById('adminTeam');
        teamSelect.innerHTML = '';
        appData.teams.forEach(team => {
            const option = document.createElement('option');
            option.value = team['íŒ€ID'];
            option.textContent = team['íŒ€ì´ë¦„'];
            teamSelect.appendChild(option);
        });
        // í¼ ì´ˆê¸°í™”
        document.getElementById('adminName').value = '';
        document.getElementById('adminEmail').value = '';
        document.getElementById('adminRole').value = '';
        document.getElementById('adminPerm1').checked = false;
        document.getElementById('adminPerm2').checked = false;
        document.getElementById('adminPerm3').checked = false;
    }

    function closeAddAdminModal() {
        document.getElementById('addAdminModal').style.display = 'none';
    }

    // ë‹´ë‹¹ì ì¶”ê°€ í•¨ìˆ˜ ê°œì„ 
    function addMemberToChannel(channelCard, memberData, channelId) {
        const memberList = channelCard.querySelector('.member-list');
        if (!memberList) {
            console.error('ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ì´ë¯¸ ì¶”ê°€ëœ ë©¤ë²„ì¸ì§€ í™•ì¸
        const existingMember = memberList.querySelector(`tr[data-member-id="${memberData.ë‹´ë‹¹ìID}"]`);
        if (existingMember) {
            console.log('ì´ë¯¸ ì¶”ê°€ëœ ë©¤ë²„ì…ë‹ˆë‹¤:', memberData.ë‹´ë‹¹ìID);
            return;
        }
        
        // ìƒˆ ë©¤ë²„ HTML ìƒì„±
        const newMemberHTML = createMemberRowHTML(memberData, channelId, currentRole, {});
        
        // tbodyì— ì¶”ê°€ (tfoot ë°”ë¡œ ì „ì—)
        const tbody = memberList.closest('tbody');
        if (tbody) {
            tbody.insertAdjacentHTML('beforeend', newMemberHTML);
        } else {
            memberList.insertAdjacentHTML('beforeend', newMemberHTML);
        }
        
        // ê³„ì‚° ë¡œì§ ì¬ì´ˆê¸°í™”
        initCalculations(channelCard);
        
        // Lucide ì•„ì´ì½˜ ì¬ìƒì„±
        lucide.createIcons();
        
        console.log('ë©¤ë²„ ì¶”ê°€ ì™„ë£Œ:', memberData.ì´ë¦„);
    }

    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    function initializeApp() {
        showLoading();
        
        // ë¨¼ì € ì—°ê²° í…ŒìŠ¤íŠ¸
        google.script.run
            .withSuccessHandler(result => {
                if (result.success) {
                    console.log('ì—°ê²° ì„±ê³µ:', result);
                    loadMonths();
                } else {
                    showError('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²° ì‹¤íŒ¨: ' + result.error);
                    hideLoading();
                }
            })
            .withFailureHandler(error => {
                console.error('Connection test failed:', error);
                showError('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ' + error.message);
                hideLoading();
            })
            .testConnection();
    }

    function loadMonths() {
        // ë¨¼ì € ì‚¬ìš©ì ì„¤ì • (í…ŒìŠ¤íŠ¸ìš© - ì‹¤ì œë¡œëŠ” getCurrentUser API í˜¸ì¶œ)
        currentUser = { 
            ì‚¬ìš©ìID: 'admin001@company.kr', // ì‹œìŠ¤í…œ ê´€ë¦¬ìëŠ” ì´ë©”ì¼ ì‚¬ìš©
            ì‚¬ìš©ìê³„ì •: 'admin001@company.kr',
            ì´ë¦„: 'ê¹€ê´€ë¦¬ì', 
            ì—­í• : 'íŒ€ì¥',
            ì†Œì†íŒ€ID: 'T03', // ë‹¨ì¼ íŒ€ ì†Œì† ì˜ˆì‹œ. ë³µìˆ˜ íŒ€ì€ 'T03,T01' í˜•ì‹
            í‰ê°€ê¶Œí•œ: ['1ì°¨', '2ì°¨', '3ì°¨'] // í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ëª¨ë“  ê¶Œí•œ ë¶€ì—¬
        };
        
        // ë³µìˆ˜ íŒ€ ì†Œì† ì²˜ë¦¬
        if (currentUser.ì†Œì†íŒ€ID && currentUser.ì†Œì†íŒ€ID.includes(',')) {
            currentUser.ì†Œì†íŒ€ëª©ë¡ = currentUser.ì†Œì†íŒ€ID.split(',').map(t => t.trim());
        } else {
            currentUser.ì†Œì†íŒ€ëª©ë¡ = currentUser.ì†Œì†íŒ€ID ? [currentUser.ì†Œì†íŒ€ID] : [];
        }
        
        console.log('í˜„ì¬ ì‚¬ìš©ì ì •ë³´:', currentUser);
        
        // í‰ê°€ì›” ëª©ë¡ ë¡œë“œ
        google.script.run
            .withSuccessHandler(months => {
                const monthSelectEl = document.getElementById('evaluation-month-select');
                if (!monthSelectEl) {
                    console.error('ì›” ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                monthSelectEl.innerHTML = '<option value="">ì›” ì„ íƒ...</option>';
                if (!months || months.length === 0) {
                    // ìƒˆ ì›” ì¶”ê°€
                    const currentDate = new Date();
                    const currentYearMonth = currentDate.getFullYear() + 'ë…„ ' + (currentDate.getMonth() + 1) + 'ì›”';
                    monthSelectEl.innerHTML += `<option value="${currentYearMonth}">${currentYearMonth}</option>`;
                    currentMonth = currentYearMonth;
                } else {
                    months.forEach(month => {
                        monthSelectEl.innerHTML += `<option value="${month}">${month}</option>`;
                    });
                    currentMonth = months[0]; // ê°€ì¥ ìµœê·¼ ì›” ì„ íƒ
                }
                monthSelectEl.value = currentMonth;
                
                // ê¶Œí•œì— ë”°ë¼ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
                updateRoleButtons();
                
                // íŒ€ ëª©ë¡ ì„¤ì • (ë³µìˆ˜ íŒ€ ì†Œì†ì¸ ê²½ìš°)
                if (currentUser.ì†Œì†íŒ€ëª©ë¡ && currentUser.ì†Œì†íŒ€ëª©ë¡.length > 1) {
                    setupTeamSelector();
                }
                
                // ê¸°ë³¸ ì—­í•  ì„ íƒ (ê¶Œí•œì´ ìˆëŠ” ì²« ë²ˆì§¸ ì—­í• )
                if (currentUser.í‰ê°€ê¶Œí•œ.includes('1ì°¨')) {
                    switchView('teamLead');
                } else if (currentUser.í‰ê°€ê¶Œí•œ.includes('2ì°¨')) {
                    switchView('manager');
                } else if (currentUser.í‰ê°€ê¶Œí•œ.includes('3ì°¨')) {
                    switchView('finalApprover');
                } else {
                    showError('í‰ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                    hideLoading();
                }
            })
            .withFailureHandler(error => {
                console.error('Failed to load months:', error);
                showError('í‰ê°€ì›” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                hideLoading();
            })
            .getEvaluationMonths();
    }
    
    // íŒ€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì„¤ì •
    function setupTeamSelector() {
        if (!teamSelector || !teamSelect) return;
        
        // íŒ€ì¥ ì—­í• ì¼ ë•Œë§Œ íŒ€ ì„ íƒ í‘œì‹œ
        teamSelector.style.display = 'flex';
        
        // ì²« ë²ˆì§¸ íŒ€ì„ ê¸°ë³¸ ì„ íƒ
        selectedTeamId = currentUser.ì†Œì†íŒ€ëª©ë¡[0];
        
        // ì‹¤ì œ íŒ€ ì •ë³´ ë¡œë“œëŠ” ë°ì´í„° ë¡œë“œ í›„ì— ìˆ˜í–‰
    }
    
    // íŒ€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    function updateTeamSelector() {
        if (!teamSelect || !currentUser.ì†Œì†íŒ€ëª©ë¡ || currentUser.ì†Œì†íŒ€ëª©ë¡.length <= 1) return;
        
        teamSelect.innerHTML = '<option value="">íŒ€ ì„ íƒ...</option>';
        
        currentUser.ì†Œì†íŒ€ëª©ë¡.forEach(teamId => {
            const team = appData.teams.find(t => t['íŒ€ID'] === teamId);
            if (team) {
                const option = document.createElement('option');
                option.value = teamId;
                option.textContent = team['íŒ€ì´ë¦„'];
                teamSelect.appendChild(option);
            }
        });
        
        teamSelect.value = selectedTeamId || currentUser.ì†Œì†íŒ€ëª©ë¡[0];
    }
    
    // ê¶Œí•œì— ë”°ë¥¸ ì—­í•  ë²„íŠ¼ ì—…ë°ì´íŠ¸
    function updateRoleButtons() {
        if (!currentUser || !currentUser.í‰ê°€ê¶Œí•œ) return;
        
        // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        buttons.teamLead.disabled = !currentUser.í‰ê°€ê¶Œí•œ.includes('1ì°¨');
        buttons.manager.disabled = !currentUser.í‰ê°€ê¶Œí•œ.includes('2ì°¨');
        buttons.finalApprover.disabled = !currentUser.í‰ê°€ê¶Œí•œ.includes('3ì°¨');
        
        // ë¹„í™œì„±í™”ëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼
        Object.entries(buttons).forEach(([role, btn]) => {
            if (btn.disabled) {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
    }

    // ë°ì´í„° ë¡œë“œ - ìˆ˜ì •ë¨
    function loadData(role) {
        if (!currentUser || !currentMonth) {
            showError('ì‚¬ìš©ì ì •ë³´ë‚˜ í‰ê°€ì›”ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        showLoading();
        
        // í•œê¸€ roleì„ ì˜ë¬¸ìœ¼ë¡œ ë³€í™˜
        const roleToViewType = {
            'íŒ€ì¥': 'teamLead',
            'ê´€ë¦¬ì': 'manager',
            'ìµœì¢…ê´€ë¦¬ì': 'finalApprover'
        };
        const viewType = roleToViewType[role] || currentRole;
        
        // ì‚¬ìš©ìê³„ì •ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì‚¬ìš©ìID ì‚¬ìš©
        const userIdentifier = currentUser.ì‚¬ìš©ìê³„ì • || currentUser.ì‚¬ìš©ìID;
        
        // ë°ì´í„° ë¡œë“œ
        google.script.run
            .withSuccessHandler(data => {
                console.log('ë°ì´í„° ë¡œë“œ ì„±ê³µ:', data);
                appData = data || { teams: [], channels: [], evaluations: [], users: [], members: [] };
                
                // íŒ€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ (íŒ€ì¥ì´ê³  ë³µìˆ˜ íŒ€ ì†Œì†ì¸ ê²½ìš°)
                if (viewType === 'teamLead' && currentUser.ì†Œì†íŒ€ëª©ë¡ && currentUser.ì†Œì†íŒ€ëª©ë¡.length > 1) {
                    updateTeamSelector();
                }
                
                // í‰ê°€ ì§„í–‰ìƒíƒœ ë¡œë“œ
                loadEvaluationStatus(() => {
                    renderView(viewType); // ì˜ë¬¸ viewType ì „ë‹¬
                    hideLoading();
                    
                    // renderView í›„ì— ë·° í‘œì‹œ
                    if (views[viewType]) {
                        views[viewType].classList.remove('hidden');
                        console.log(viewType + ' ë·° í‘œì‹œë¨');
                    }
                });
            })
            .withFailureHandler(error => {
                console.error('Failed to load data:', error);
                showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                hideLoading();
            })
            .getDataByRole(userIdentifier, role, currentMonth);
    }

    // í‰ê°€ ì§„í–‰ìƒíƒœ ë¡œë“œ - ìƒˆë¡œ ì¶”ê°€
    function loadEvaluationStatus(callback) {
        google.script.run
            .withSuccessHandler(status => {
                console.log('í‰ê°€ ì§„í–‰ìƒíƒœ:', status);
                evaluationStatus = status || { channelStatus: {}, teamStatus: {} };
                if (callback) callback();
            })
            .withFailureHandler(error => {
                console.error('Failed to load evaluation status:', error);
                evaluationStatus = { channelStatus: {}, teamStatus: {} };
                if (callback) callback();
            })
            .getEvaluationStatus(currentMonth);
    }

    // í‰ê°€ ë°ì´í„° ì €ì¥
    function saveEvaluationData(evaluations, isDraft = false) {
        console.log('saveEvaluationData í˜¸ì¶œ:', {
            evaluations: evaluations,
            isDraft: isDraft,
            count: evaluations.length
        });
        
        showLoading();
        google.script.run
            .withSuccessHandler(result => {
                console.log('ì €ì¥ ì„±ê³µ:', result);
                if (result.success) {
                    const successMsg = isDraft ? 
                        'ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 
                        (currentRole === 'teamLead' ? '1ì°¨ í‰ê°€ê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.' :
                         currentRole === 'manager' ? '2ì°¨ í‰ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' :
                         'ìµœì¢… í‰ê°€ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    showSuccess(successMsg);
                    // ë°ì´í„° ë¦¬í”„ë ˆì‹œ
                    const roleMap = {
                        'teamLead': 'íŒ€ì¥',
                        'manager': 'ê´€ë¦¬ì',
                        'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
                    };
                    loadData(roleMap[currentRole]);
                } else {
                    showError(result.message);
                    hideLoading();
                }
            })
            .withFailureHandler(error => {
                console.error('Failed to save:', error);
                showError('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                hideLoading();
            })
            .saveEvaluationBatch(evaluations);
    }

    // ë™ì  HTML ìƒì„± í•¨ìˆ˜ë“¤ - ìˆ˜ì •ë¨
    function createMemberRowHTML(member, channelId, viewType, evaluationData = {}) {
        const memberName = member['ì´ë¦„'];
        const memberId = member['ë‹´ë‹¹ìID'];
        
        let colspan = viewType === 'manager' ? 5 : (viewType === 'finalApprover' ? 6 : 4);
        let rowHTML = `<tr class="table-row" data-member-id="${memberId}" data-member-name="${memberName}" data-channel-id="${channelId}">
            <td class="px-6 py-4 font-medium">${memberName}</td>`;
        
        if (viewType === 'teamLead') {
            rowHTML += `
                <td class="px-6 py-4"><input type="number" step="0.1" value="${evaluationData['íˆ¬ì…MM'] || 0}" class="w-20 p-1 rounded-md border border-gray-600 mm-input input-field"></td>
                <td class="px-6 py-4"><input type="number" min="0" max="100" value="${evaluationData['1ì°¨ê¸°ì—¬ë„'] || 0}" class="w-20 p-1 rounded-md border border-gray-600 perc-input input-field"></td>`;
        } else if (viewType === 'manager') {
            rowHTML += `
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${evaluationData['íˆ¬ì…MM'] || 0}</div></td>
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${evaluationData['1ì°¨ê¸°ì—¬ë„'] || 0}%</div></td>
                <td class="px-6 py-4"><input type="number" min="0" max="100" value="${evaluationData['2ì°¨ê¸°ì—¬ë„'] || 0}" class="w-20 p-1 rounded-md border border-gray-600 perc-input input-field"></td>`;
        } else if (viewType === 'finalApprover') {
            const contrib = evaluationData['2ì°¨ê¸°ì—¬ë„'] || 0;
            rowHTML += `
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${evaluationData['1ì°¨ê¸°ì—¬ë„'] || 0}%</div></td>
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-20">${contrib}%</div></td>
                <td class="px-6 py-4"><div class="p-1 readonly-field text-center w-32 contribution-incentive">0 ë§Œì›</div></td>
                <td class="px-6 py-4"><input type="number" value="${evaluationData['ì‹¤ì§€ê¸‰ì„±ê³¼ê¸ˆ'] || 0}" class="w-32 p-1 rounded-md border border-gray-600 final-incentive-input input-field"></td>`;
        }
        
        rowHTML += `
            <td class="px-6 py-4 text-center">
                <button class="toggle-comment hover:text-indigo-400"><i data-lucide="plus-circle"></i></button>
                <div class="dropdown inline-block ml-2">
                    <button class="toggle-menu p-1 rounded-full hover:bg-gray-600"><i data-lucide="more-vertical" class="w-4 h-4"></i></button>
                    <div class="dropdown-content">
                        <a class="remove-btn btn-danger">ì‚­ì œ</a>
                    </div>
                </div>
            </td>
        </tr>
        <tr class="comment-row hidden" data-member-id="${memberId}">
            <td colspan="${colspan}" class="p-0 detail-section">
                ${createCommentSectionHTML(viewType, evaluationData)}
            </td>
        </tr>`;
        
        return rowHTML;
    }

    function createCommentSectionHTML(viewType, evaluationData = {}) {
        let corePerformanceHTML = '';
        
        if (viewType === 'teamLead') {
            const performances = (evaluationData['1ì°¨ì„±ê³¼ê¸ˆ'] || '').split('||').filter(p => p);
            corePerformanceHTML = `
                <div>
                    <h4 class="font-bold mb-3 flex items-center gap-2">ğŸ“Š ê°œì¸ë³„ í•µì‹¬ ì„±ê³¼</h4>
                    <div class="text-sm space-y-2 core-performance-container">
                        <div class="grid grid-cols-5 gap-2 items-center">
                            <span class="col-span-2 text-gray-400">ì„±ê³¼ í•­ëª©</span>
                            <span class="col-span-3 text-gray-400">ë‚´ìš© ë° ìˆ˜ì¹˜</span>
                        </div>`;
            
            if (performances.length > 0) {
                performances.forEach(perf => {
                    const [title, value] = perf.split('|');
                    corePerformanceHTML += `
                        <div class="grid grid-cols-5 gap-2 items-center performance-item">
                            <input type="text" value="${title || ''}" placeholder="ì˜ˆ: ìµœê³  ì¡°íšŒìˆ˜ ì˜ìƒ" class="col-span-2 bg-gray-800 rounded p-1 performance-title">
                            <input type="text" value="${value || ''}" placeholder="ì˜ˆ: ìš°ì£¼ë‹¤í (230ë§Œ)" class="col-span-3 bg-gray-800 rounded p-1 performance-value">
                        </div>`;
                });
            } else {
                corePerformanceHTML += `
                        <div class="grid grid-cols-5 gap-2 items-center performance-item">
                            <input type="text" placeholder="ì˜ˆ: ìµœê³  ì¡°íšŒìˆ˜ ì˜ìƒ" class="col-span-2 bg-gray-800 rounded p-1 performance-title">
                            <input type="text" placeholder="ì˜ˆ: ìš°ì£¼ë‹¤í (230ë§Œ)" class="col-span-3 bg-gray-800 rounded p-1 performance-value">
                        </div>`;
            }
            
            corePerformanceHTML += `
                        <button class="text-indigo-400 hover:text-indigo-300 text-xs mt-2 add-performance-btn">+ í•­ëª© ì¶”ê°€</button>
                    </div>
                </div>`;
        } else {
            // ì„±ê³¼ ë‚´ìš©ì„ ë³´ê¸° ì¢‹ê²Œ í‘œì‹œ
            const performances = (evaluationData['1ì°¨ì„±ê³¼ê¸ˆ'] || '').split('||').filter(p => p);
            let performanceText = '1ì°¨ í‰ê°€ ì‹œ ì…ë ¥ëœ ì„±ê³¼ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.';
            if (performances.length > 0) {
                performanceText = performances.map(p => {
                    const [title, value] = p.split('|');
                    return `â€¢ ${title}: ${value}`;
                }).join('\n');
            }
            
            corePerformanceHTML = `
                <div>
                    <h4 class="font-bold mb-3 flex items-center gap-2">ğŸ“Š 1ì°¨ í•µì‹¬ ì„±ê³¼</h4>
                    <p class="text-sm text-gray-300 readonly-field p-2 rounded-md whitespace-pre-line">${performanceText}</p>
                </div>`;
        }
        
        if (viewType === 'teamLead') {
            return `
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${corePerformanceHTML}
                    <div>
                        <h4 class="font-bold mb-3 flex items-center gap-2">ğŸ’¬ 1ì°¨ ì½”ë©˜íŠ¸</h4>
                        <textarea class="w-full p-2 border rounded-md comment-textarea input-field comment-1" placeholder="1ì°¨ í‰ê°€ ì½”ë©˜íŠ¸ë¥¼ ê¸°ë¡í•´ì£¼ì„¸ìš”.">${evaluationData['1ì°¨ì½”ë©˜íŠ¸'] || ''}</textarea>
                    </div>
                </div>`;
        } else if (viewType === 'manager') {
            return `
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${corePerformanceHTML}
                    <div>
                        <h4 class="font-bold mb-2 flex items-center gap-2">ğŸ’¬ 1ì°¨ ì½”ë©˜íŠ¸ (íŒ€ì¥)</h4>
                        <p class="text-sm text-gray-300 readonly-field p-2 rounded-md mb-2">${evaluationData['1ì°¨ì½”ë©˜íŠ¸'] || '1ì°¨ í‰ê°€ê°€ ì•„ì§ ì œì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                        <h4 class="font-bold mb-2 flex items-center gap-2">ğŸ’¬ 2ì°¨ ì½”ë©˜íŠ¸</h4>
                        <textarea class="w-full p-2 border rounded-md comment-textarea input-field comment-2" placeholder="2ì°¨ í‰ê°€ ì½”ë©˜íŠ¸ë¥¼ ê¸°ë¡í•´ì£¼ì„¸ìš”.">${evaluationData['2ì°¨ì½”ë©˜íŠ¸'] || ''}</textarea>
                    </div>
                </div>`;
        } else if (viewType === 'finalApprover') {
            return `
                <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${corePerformanceHTML}
                    <div>
                        <h4 class="font-bold mb-2 flex items-center gap-2">ğŸ’¬ 1ì°¨ ì½”ë©˜íŠ¸ (íŒ€ì¥)</h4>
                        <p class="text-sm text-gray-300 readonly-field p-2 rounded-md">${evaluationData['1ì°¨ì½”ë©˜íŠ¸'] || '1ì°¨ í‰ê°€ê°€ ì•„ì§ ì œì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                        <h4 class="font-bold mt-4 mb-2 flex items-center gap-2">ğŸ’¬ 2ì°¨ ì½”ë©˜íŠ¸ (ê´€ë¦¬ì)</h4>
                        <p class="text-sm text-gray-300 readonly-field p-2 rounded-md">${evaluationData['2ì°¨ì½”ë©˜íŠ¸'] || '2ì°¨ í‰ê°€ê°€ ì•„ì§ ì œì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                        <h4 class="font-bold mt-4 mb-2 flex items-center gap-2">ğŸ’¬ ìµœì¢… ì½”ë©˜íŠ¸</h4>
                        <textarea class="w-full p-2 border rounded-md comment-textarea input-field comment-final" placeholder="ìµœì¢… ì½”ë©˜íŠ¸ë¥¼ ê¸°ë¡í•´ì£¼ì„¸ìš”.">${evaluationData['ìµœì¢…ì½”ë©˜íŠ¸'] || ''}</textarea>
                    </div>
                </div>`;
        }
        return '';
    }

    function createChannelHTML(channel, viewType) {
        const channelId = channel['ì±„ë„ID'];
        const channelName = channel['ì±„ë„ì´ë¦„'];
        
        // í•´ë‹¹ ì±„ë„ì˜ í‰ê°€ ë°ì´í„° í•„í„°ë§
        const channelEvaluations = appData.evaluations.filter(e => e['ì±„ë„ID'] === channelId);
        
        // ì±„ë„ì˜ ë©¤ë²„ ëª©ë¡ êµ¬ì„±
        let members = [];
        
        if (channelEvaluations.length > 0) {
            // í‰ê°€ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
            const memberIds = [...new Set(channelEvaluations.map(e => e['ë‹´ë‹¹ìID']))];
            members = memberIds.map(id => {
                const member = appData.members.find(m => m['ë‹´ë‹¹ìID'] === id);
                return member || { ë‹´ë‹¹ìID: id, ì´ë¦„: channelEvaluations.find(e => e['ë‹´ë‹¹ìID'] === id)['ë‹´ë‹¹ìì´ë¦„'] || 'ì•Œ ìˆ˜ ì—†ìŒ' };
            }).filter(Boolean);
        } else {
            // í‰ê°€ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì±„ë„ì— ì†í•œ ë‹´ë‹¹ì í‘œì‹œ
            members = appData.members.filter(m => m['ì†Œì†ì±„ë„ID'] === channelId);
        }
        
        // í‰ê°€ ì§„í–‰ìƒíƒœ í‘œì‹œ
        const channelStatus = evaluationStatus.channelStatus[channelId] || 'ë¯¸ì‹œì‘';
        const statusBadge = `<span class="status-badge status-${channelStatus}">${channelStatus}</span>`;
        
        let tableHeader = '';
        if (viewType === 'teamLead') {
            tableHeader = `<tr><th class="px-6 py-3">ë‹´ë‹¹ì</th><th class="px-6 py-3">íˆ¬ì… MM</th><th class="px-6 py-3">1ì°¨ ê¸°ì—¬ë„ (%)</th><th class="px-6 py-3 text-center">ìƒì„¸ ì •ë³´</th></tr>`;
        } else if (viewType === 'manager') {
            tableHeader = `<tr><th class="px-6 py-3">ë‹´ë‹¹ì</th><th class="px-6 py-3">íˆ¬ì…MM</th><th class="px-6 py-3">1ì°¨ ê¸°ì—¬ë„(ì°¸ê³ )</th><th class="px-6 py-3">2ì°¨ ê¸°ì—¬ë„ (%)</th><th class="px-6 py-3 text-center">ìƒì„¸ ì •ë³´</th></tr>`;
        } else if (viewType === 'finalApprover') {
            tableHeader = `<tr><th class="px-6 py-3">ë‹´ë‹¹ì</th><th class="px-6 py-3">1ì°¨ ê¸°ì—¬ë„</th><th class="px-6 py-3">2ì°¨ ê¸°ì—¬ë„</th><th class="px-6 py-3">ê¸°ì—¬ë„ì„±ê³¼ê¸ˆ(ì°¸ê³ )</th><th class="px-6 py-3">ì‹¤ì§€ê¸‰ ì„±ê³¼ê¸ˆ(ë§Œì›)</th><th class="px-6 py-3 text-center">ìƒì„¸ ì •ë³´</th></tr>`;
        }
        
        let budgetSection = '';
        if(viewType === 'finalApprover') {
            const channelBudget = channelEvaluations[0] || {};
            budgetSection = `
                <div class="p-5 border-y border-gray-700">
                    <div class="grid grid-cols-12 gap-x-4 gap-y-2 items-end">
                        <div class="col-span-12 sm:col-span-6 md:col-span-2 flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-400">ì‚¬ì—…íš¨ìœ¨(%)</label>
                            <div class="relative">
                                <input type="number" value="${channelBudget['ì‚¬ì—…íš¨ìœ¨'] || 80}" class="w-full p-2 pr-6 rounded-md text-lg font-bold text-center efficiency-input input-field input-field-green">
                                <span class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-gray-400">%</span>
                            </div>
                        </div>
                        <div class="col-span-12 sm:col-span-6 md:col-span-3 flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-400">1ì°¨ ì„±ê³¼ê¸ˆ(ë§Œì›)</label>
                            <input type="number" value="${channelBudget['íŒ€ì¥ì„±ê³¼ê¸ˆ'] || 500}" class="w-full p-2 rounded-md text-lg font-bold text-center incentive1-input input-field">
                        </div>
                        <div class="col-span-12 sm:col-span-6 md:col-span-3 flex flex-col gap-1">
                            <label class="text-sm font-medium text-gray-400">íŒ€ì¥ì„±ê³¼(%)</label>
                            <input type="number" value="${channelBudget['íŒ€ì¥ì„±ê³¼'] || 20}" class="w-full p-2 rounded-md text-lg font-bold text-center lead-perc-input input-field">
                        </div>
                        <div class="col-span-12 md:col-span-4 flex flex-col gap-1">
                            <h4 class="text-sm font-medium text-gray-400">2ì°¨ ì„±ê³¼ê¸ˆ (ë°°ë¶„ëŒ€ìƒ)</h4>
                            <div class="mt-1 p-2 rounded-md text-lg font-bold incentive-pool-field incentive2-output">400 ë§Œì›</div>
                            <div class="w-full mt-1 remaining-bar">
                                <div class="h-2 remaining-bar-fill incentive-progress-bar-fill" style="width: 0%;"></div>
                            </div>
                            <p class="text-xs text-right text-gray-400 incentive-ratio mt-1"></p>
                        </div>
                    </div>
                </div>`;
        }

        const membersHTML = members.map(member => {
            const evalData = channelEvaluations.find(e => e['ë‹´ë‹¹ìID'] === member['ë‹´ë‹¹ìID']) || {};
            return createMemberRowHTML(member, channelId, viewType, evalData);
        }).join('');
        
        let footer = '';
        if (viewType === 'teamLead') {
            footer = `<tfoot class="font-semibold table-header"><tr><td class="px-6 py-3 text-right">í•©ê³„</td><td class="px-6 py-3 font-bold total-mm">0.0</td><td class="px-6 py-3 font-bold total-perc">0%</td><td><button class="add-member-btn text-indigo-300 hover:text-indigo-100 text-xs ml-4">+ ë‹´ë‹¹ì</button></td></tr></tfoot>`;
        } else if (viewType === 'manager') {
            footer = `<tfoot class="font-semibold table-header"><tr><td class="px-6 py-3 text-right" colspan="3">í•©ê³„</td><td class="px-6 py-3 font-bold total-perc">0%</td><td>${members.length === 0 ? '<button class="add-member-btn text-indigo-300 hover:text-indigo-100 text-xs ml-4">+ ë‹´ë‹¹ì</button>' : ''}</td></tr></tfoot>`;
        } else if (viewType === 'finalApprover') {
            footer = `<tfoot class="font-semibold table-header"><tr><td class="px-6 py-3 text-right" colspan="4">ì‹¤ì§€ê¸‰ í•©ê³„</td><td class="px-6 py-3 font-bold total-final-incentive">0 ë§Œì›</td><td>${members.length === 0 ? '<button class="add-member-btn text-indigo-300 hover:text-indigo-100 text-xs ml-4">+ ë‹´ë‹¹ì</button>' : ''}</td></tr></tfoot>`;
        }

        return `
            <div class="card rounded-lg shadow-md" data-channel-id="${channelId}">
                <div class="p-5">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <button class="toggle-channel-comment p-1 rounded-full hover:bg-gray-700"><i data-lucide="plus-circle"></i></button>
                            <h3 class="text-xl font-bold">${channelName}</h3>
                            ${statusBadge}
                        </div>
                        <div class="dropdown">
                            <button class="toggle-menu p-1 rounded-full hover:bg-gray-600"><i data-lucide="more-vertical" class="w-4 h-4"></i></button>
                            <div class="dropdown-content">
                                <a class="remove-btn btn-danger">ì±„ë„ ì‚­ì œ</a>
                            </div>
                        </div>
                    </div>
                    ${viewType !== 'finalApprover' ? `
                    <div class="mt-3 text-sm text-gray-400">
                        <span>ì”ì—¬ ê¸°ì—¬ë„: </span>
                        <span class="font-bold text-lg text-green-400 remaining-perc">100%</span>
                        <div class="w-full mt-1 remaining-bar">
                            <div class="h-2 remaining-bar-fill" style="width: 0%;"></div>
                        </div>
                    </div>` : ''}
                </div>
                <div class="channel-comment-section hidden p-4 border-y border-gray-700 detail-section">
                    <h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="clipboard-edit"></i>ì±„ë„ ì¢…í•© ì½”ë©˜íŠ¸</h4>
                    <textarea class="w-full p-2 border rounded-md comment-textarea channel-comment" placeholder="ì±„ë„ ì „ì²´ì— ëŒ€í•œ ì¢…í•© ì½”ë©˜íŠ¸ë¥¼ ê¸°ë¡í•´ì£¼ì„¸ìš”.">${channelEvaluations[0]?.['ì±„ë„ì½”ë©˜íŠ¸'] || ''}</textarea>
                </div>
                ${budgetSection}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="table-header">${tableHeader}</thead>
                        <tbody class="member-list">${membersHTML}</tbody>
                        ${footer}
                    </table>
                </div>
            </div>`;
    }
    
    function createTeamCardHTML(team, viewType) {
        const teamId = team['íŒ€ID'];
        const teamName = team['íŒ€ì´ë¦„'];
        const teamChannels = appData.channels.filter(c => c['ì†Œì†íŒ€ID'] === teamId);
        
        // íŒ€ ì§„í–‰ìƒíƒœ í‘œì‹œ
        const teamStatus = evaluationStatus.teamStatus[teamId] || 'ë¯¸ì‹œì‘';
        const statusBadge = `<span class="status-badge status-${teamStatus}">${teamStatus}</span>`;
        
        const channelsHTML = teamChannels.map(channel => createChannelHTML(channel, viewType)).join('');
        
        return `
            <div class="card rounded-lg shadow-md" data-team-id="${teamId}">
                <div class="p-5 bg-gray-800 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <h2 class="text-2xl font-bold">${teamName}</h2>
                            ${statusBadge}
                        </div>
                        <div class="dropdown">
                            <button class="toggle-menu p-1 rounded-full hover:bg-gray-600"><i data-lucide="more-vertical"></i></button>
                            <div class="dropdown-content">
                                <a class="remove-btn btn-danger">íŒ€ ì‚­ì œ</a>
                                <a class="add-channel-btn">ì±„ë„ ì¶”ê°€</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 space-y-8 channel-container">${channelsHTML}</div>
            </div>`;
    }

    function renderView(viewType) {
        console.log('renderView í˜¸ì¶œë¨, viewType:', viewType);
        
        // ë§¤ê°œë³€ìˆ˜ ê²€ì¦
        if (!viewType || (viewType !== 'teamLead' && viewType !== 'manager' && viewType !== 'finalApprover')) {
            console.error('Invalid viewType:', viewType);
            return;
        }
        
        // views ê°ì²´ í™•ì¸
        if (!views || !views[viewType]) {
            console.error('View not found:', viewType);
            return;
        }
        
        const container = views[viewType];
        if (!container) {
            console.error('Container not found for viewType:', viewType);
            return;
        }
        
        console.log('Container ì°¾ìŒ:', container);
        
        let contentHTML = '';
        let footerHTML = '';

        if (viewType === 'teamLead') {
            console.log('íŒ€ì¥ ë·° ë Œë”ë§ ì‹œì‘');
            console.log('currentUser:', currentUser);
            console.log('selectedTeamId:', selectedTeamId);
            console.log('appData.teams:', appData.teams);
            
            // ì„ íƒëœ íŒ€ ë˜ëŠ” ì²« ë²ˆì§¸ ì†Œì† íŒ€
            const teamId = selectedTeamId || currentUser.ì†Œì†íŒ€ID.split(',')[0].trim();
            const userTeam = appData.teams.find(t => t['íŒ€ID'] === teamId);
            console.log('ì„ íƒëœ íŒ€ ì°¾ê¸° ê²°ê³¼:', userTeam);
            
            if (!userTeam) {
                contentHTML = '<p class="error-message">ì†Œì† íŒ€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì°¾ëŠ” íŒ€ID: ' + teamId + ')</p>';
                console.error('íŒ€ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ. íŒ€ ëª©ë¡:', appData.teams);
            } else {
                const teamChannels = appData.channels.filter(c => c['ì†Œì†íŒ€ID'] === userTeam['íŒ€ID']);
                console.log('íŒ€ ì±„ë„ë“¤:', teamChannels);
                
                const channelsHTML = teamChannels.map(channel => createChannelHTML(channel, 'teamLead')).join('');
                contentHTML = `
                    <h2 class="text-2xl font-semibold mb-4">${userTeam['íŒ€ì´ë¦„']} ì„±ê³¼ ì…ë ¥ (1ì°¨)</h2>
                    <div class="space-y-8 channel-container">${channelsHTML}</div>
                    <div class="mt-4">
                        <button class="add-channel-btn btn-secondary text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            <i data-lucide="plus"></i> ì±„ë„ ì¶”ê°€
                        </button>
                    </div>`;
                footerHTML = `
                    <button class="btn-secondary py-3 px-6 text-base rounded-lg save-draft-btn">ì„ì‹œ ì €ì¥</button>
                    <button class="btn-primary py-3 px-6 text-base rounded-lg submit-evaluation-btn">1ì°¨ í‰ê°€ ìµœì¢… ì œì¶œ</button>`;
            }
            
            // íŒ€ ì„ íƒ ë“œë¡­ë‹¤ìš´ í‘œì‹œ/ìˆ¨ê¹€
            if (teamSelector) {
                teamSelector.style.display = currentUser.ì†Œì†íŒ€ëª©ë¡ && currentUser.ì†Œì†íŒ€ëª©ë¡.length > 1 ? 'flex' : 'none';
            }
        } else {
            console.log(viewType + ' ë·° ë Œë”ë§ ì‹œì‘');
            const teamCardsHTML = appData.teams.map(team => createTeamCardHTML(team, viewType)).join('');
            const title = viewType === 'manager' ? 'ì „ì²´ ì„±ê³¼ ì·¨í•© (2ì°¨)' : 'ìµœì¢… ì„±ê³¼ê¸ˆ ì…ë ¥ (3ì°¨)';
            const buttons = viewType === 'finalApprover' ? 
                `<button class="btn-secondary py-3 px-6 text-base rounded-lg save-draft-btn">ì €ì¥í•˜ê¸°</button>
                 <button class="btn-primary py-3 px-6 text-base rounded-lg submit-evaluation-btn">ì´ë‹¬ì˜ í‰ê°€ ìµœì¢… í™•ì •</button>` : 
                `<button class="btn-primary py-3 px-6 text-base rounded-lg submit-evaluation-btn">2ì°¨ í‰ê°€ ì €ì¥</button>`;
            
            contentHTML = `
                <h2 class="text-2xl font-semibold mb-4">${title}</h2>
                <div class="space-y-8" id="${viewType}-cards">${teamCardsHTML}</div>
                <div class="mt-4 flex gap-4">
                    <button class="add-team-btn btn-secondary text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="plus"></i> íŒ€ ì¶”ê°€
                    </button>
                    ${viewType === 'finalApprover' ? `
                    <button class="add-admin-btn btn-secondary text-sm font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <i data-lucide="user-plus"></i> ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€
                    </button>` : ''}
                </div>`;
            footerHTML = buttons;
            
            // íŒ€ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¹€
            if (teamSelector) {
                teamSelector.style.display = 'none';
            }
        }
        
        console.log('ìƒì„±ëœ HTML ê¸¸ì´:', contentHTML.length);
        container.innerHTML = contentHTML;
        
        // actionFooter ì¬í™•ì¸
        const footerElement = document.getElementById('footer-buttons');
        if (footerElement) {
            footerElement.innerHTML = footerHTML;
        }
        
        initCalculations(container);
        lucide.createIcons();
        console.log('renderView ì™„ë£Œ');
    }
    
    // Undo Functionality
    function showUndoToast(message, elementToRemove) {
        clearTimeout(undoState.timer);
        const toast = document.getElementById('undo-toast');
        document.getElementById('undo-message').textContent = message;

        undoState.element = elementToRemove;
        undoState.parent = elementToRemove.parentNode;
        undoState.nextSibling = elementToRemove.nextElementSibling;
        
        elementToRemove.style.display = 'none';
        toast.classList.add('show');
        
        undoState.timer = setTimeout(() => {
            if (undoState.element && undoState.element.parentNode) {
                undoState.element.remove();
            }
            hideUndoToast();
        }, 5000);
    }

    function hideUndoToast() {
        const toast = document.getElementById('undo-toast');
        toast.classList.remove('show');
        clearTimeout(undoState.timer);
        undoState = { timer: null, element: null, parent: null, nextSibling: null };
    }

    // Event Delegation
    document.getElementById('main-container').addEventListener('click', (e) => {
        const target = e.target;

        // Dropdown Menu Toggle
        const menuBtn = target.closest('.toggle-menu');
        if (menuBtn) {
            e.preventDefault();
            const dropdownContent = menuBtn.nextElementSibling;
            document.querySelectorAll('.dropdown-content.show').forEach(d => {
                if (d !== dropdownContent) d.classList.remove('show');
            });
            dropdownContent.classList.toggle('show');
            return;
        }
        if (!target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-content.show').forEach(d => d.classList.remove('show'));
        }

        // Remove Button
        if (target.closest('.remove-btn')) {
            e.preventDefault();
            let elementToRemove;
            let message = "í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";

            const memberRow = target.closest('tr.table-row');
            if (memberRow) {
                elementToRemove = memberRow;
                const commentRow = memberRow.nextElementSibling;
                if (commentRow && commentRow.classList.contains('comment-row')) {
                    commentRow.remove();
                }
                message = `${memberRow.dataset.memberName} ë‹˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;
            } else {
                const card = target.closest('.card[data-channel-id]') || target.closest('.card[data-team-id]');
                if (card) {
                    elementToRemove = card;
                    message = card.dataset.channelId ? "ì±„ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤." : "íŒ€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
                }
            }
            
            if (elementToRemove) {
                showUndoToast(message, elementToRemove);
                target.closest('.dropdown-content').classList.remove('show');
            }
            return;
        }

        // Toggle Comment Sections
        const toggleBtn = target.closest('.toggle-comment, .toggle-channel-comment');
        if (toggleBtn) {
            e.preventDefault();
            const isMemberComment = toggleBtn.classList.contains('toggle-comment');
            const section = isMemberComment 
                ? toggleBtn.closest('tr').nextElementSibling 
                : toggleBtn.closest('.card').querySelector('.channel-comment-section');
            
            section.classList.toggle('hidden');
            toggleBtn.innerHTML = section.classList.contains('hidden') ? '<i data-lucide="plus-circle"></i>' : '<i data-lucide="minus-circle"></i>';
            lucide.createIcons();
            return;
        }

        // Add Performance Item
        if (target.closest('.add-performance-btn')) {
            e.preventDefault();
            const container = target.closest('.core-performance-container');
            const newItem = document.createElement('div');
            newItem.className = 'grid grid-cols-5 gap-2 items-center performance-item';
            newItem.innerHTML = `
                <input type="text" placeholder="ì˜ˆ: ìµœê³  ì¡°íšŒìˆ˜ ì˜ìƒ" class="col-span-2 bg-gray-800 rounded p-1 performance-title">
                <input type="text" placeholder="ì˜ˆ: ìš°ì£¼ë‹¤í (230ë§Œ)" class="col-span-3 bg-gray-800 rounded p-1 performance-value">`;
            container.insertBefore(newItem, target);
            return;
        }

        // Add Member
        if (target.closest('.add-member-btn')) {
            e.preventDefault();
            const channelCard = target.closest('.card[data-channel-id]');
            const channelId = channelCard.dataset.channelId;
            const channel = appData.channels.find(c => c['ì±„ë„ID'] === channelId);
            const teamId = channel ? channel['ì†Œì†íŒ€ID'] : null;
            
            // ëª¨ë‹¬ ì—´ê¸°
            openAddMemberModal(channelId, teamId);
            return;
        }

        // Add Channel
        if (target.closest('.add-channel-btn')) {
            const teamCard = target.closest('.card[data-team-id]');
            const teamId = teamCard ? teamCard.dataset.teamId : (selectedTeamId || currentUser.ì†Œì†íŒ€ID.split(',')[0].trim());
            const channelName = prompt('ìƒˆ ì±„ë„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (channelName) {
                showLoading();
                google.script.run
                    .withSuccessHandler(result => {
                        if (result.success) {
                            showSuccess('ì±„ë„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            const roleMap = {
                                'teamLead': 'íŒ€ì¥',
                                'manager': 'ê´€ë¦¬ì',
                                'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
                            };
                            loadData(roleMap[currentRole]);
                        } else {
                            showError(result.message);
                            hideLoading();
                        }
                    })
                    .withFailureHandler(error => {
                        console.error('Failed to add channel:', error);
                        showError('ì±„ë„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        hideLoading();
                    })
                    .addChannel({ name: channelName, teamId: teamId });
            }
            return;
        }

        // Add Team
        if (target.closest('.add-team-btn')) {
            const teamName = prompt('ìƒˆ íŒ€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (teamName) {
                showLoading();
                google.script.run
                    .withSuccessHandler(result => {
                        if (result.success) {
                            showSuccess('íŒ€ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            const roleMap = {
                                'teamLead': 'íŒ€ì¥',
                                'manager': 'ê´€ë¦¬ì',
                                'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
                            };
                            loadData(roleMap[currentRole]);
                        } else {
                            showError(result.message);
                            hideLoading();
                        }
                    })
                    .withFailureHandler(error => {
                        console.error('Failed to add team:', error);
                        showError('íŒ€ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        hideLoading();
                    })
                    .addTeam({ name: teamName });
            }
            return;
        }

        // Add Admin (ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€)
        if (target.closest('.add-admin-btn')) {
            e.preventDefault();
            openAddAdminModal();
            return;
        }
    });

    // footer ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„ ì¶”ê°€
    document.getElementById('action-footer').addEventListener('click', (e) => {
        const target = e.target;
        
        // Save/Submit Buttons
        if (target.closest('.save-draft-btn, .submit-evaluation-btn')) {
            e.preventDefault();
            console.log('ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨');
            const isDraft = target.closest('.save-draft-btn') !== null;
            console.log('ì„ì‹œì €ì¥:', isDraft);
            collectAndSaveData(isDraft);
            return;
        }
    });

    // ê³„ì‚° ë¡œì§ ì´ˆê¸°í™”
    function initCalculations(scopeElement) {
        if (!scopeElement) return;

        const cards = scopeElement.matches('.card[data-channel-id]') ? [scopeElement] : scopeElement.querySelectorAll('.card[data-channel-id]');
        
        cards.forEach(card => {
            const calculate = () => {
                // ê¸°ì—¬ë„ ê³„ì‚°
                const percInputs = card.querySelectorAll('.perc-input');
                if (percInputs.length > 0) {
                    let totalPerc = 0;
                    percInputs.forEach(input => { 
                        totalPerc += parseFloat(input.value) || 0; 
                    });
                    
                    const remaining = 100 - totalPerc;
                    const remainingEl = card.querySelector('.remaining-perc');
                    if (remainingEl) {
                        remainingEl.textContent = `${remaining}%`;
                        remainingEl.classList.toggle('text-red-500', remaining < 0);
                        remainingEl.classList.toggle('text-green-400', remaining >= 0);
                    }
                    const remainingBarFill = card.querySelector('.remaining-bar-fill');
                    if(remainingBarFill) {
                        remainingBarFill.style.width = `${Math.min(100, totalPerc)}%`;
                        remainingBarFill.classList.toggle('over', totalPerc > 100);
                    }
                    
                    const totalPercEl = card.querySelector('.total-perc');
                    if (totalPercEl) totalPercEl.textContent = `${totalPerc}%`;
                }
                
                // MM ê³„ì‚°
                const mmInputs = card.querySelectorAll('.mm-input');
                if (mmInputs.length > 0) {
                    let totalMM = 0; 
                    mmInputs.forEach(input => { 
                        totalMM += parseFloat(input.value) || 0; 
                    });
                    const totalMMEl = card.querySelector('.total-mm');
                    if (totalMMEl) totalMMEl.textContent = totalMM.toFixed(1);
                }
                
                // ìµœì¢… ì„±ê³¼ê¸ˆ ê³„ì‚°
                if (card.querySelector('.incentive1-input')) {
                    const incentive1 = parseFloat(card.querySelector('.incentive1-input').value) || 0;
                    const leadPerc = (parseFloat(card.querySelector('.lead-perc-input').value) || 0) / 100;
                    const incentive2ForDistribution = incentive1 * (1 - leadPerc);

                    let totalManualPaid = 0;
                    card.querySelectorAll('.final-incentive-input').forEach(input => {
                        totalManualPaid += parseFloat(input.value) || 0;
                    });
                    
                    const totalFinalIncentiveEl = card.querySelector('.total-final-incentive');
                    if(totalFinalIncentiveEl) {
                        totalFinalIncentiveEl.textContent = `${formatCurrency(totalManualPaid)} ë§Œì›`;
                    }

                    const incentive2OutputEl = card.querySelector('.incentive2-output');
                    if(incentive2OutputEl) {
                        incentive2OutputEl.textContent = `${formatCurrency(incentive2ForDistribution.toFixed(0))} ë§Œì›`;
                    }
                    
                    const incentiveRatioEl = card.querySelector('.incentive-ratio');
                    if(incentiveRatioEl) {
                        const ratio = incentive2ForDistribution > 0 ? (totalManualPaid / incentive2ForDistribution * 100) : 0;
                        incentiveRatioEl.textContent = `${formatCurrency(totalManualPaid)} / ${formatCurrency(incentive2ForDistribution.toFixed(0))} ë§Œì› (${ratio.toFixed(0)}%)`;
                        incentiveRatioEl.classList.toggle('text-red-400', ratio > 100);
                    }

                    const progressPercentage = incentive2ForDistribution > 0 ? (totalManualPaid / incentive2ForDistribution) * 100 : 0;
                    const incentiveProgressBar = card.querySelector('.incentive-progress-bar-fill');
                    if(incentiveProgressBar) {
                        incentiveProgressBar.style.width = `${Math.min(100, progressPercentage)}%`;
                        incentiveProgressBar.classList.toggle('over', progressPercentage > 100);
                    }

                    // ìë™ ê³„ì‚°ëœ ê¸°ì—¬ë„ ì„±ê³¼ê¸ˆ
                    let totalContribution = 0;
                    const memberRows = card.querySelectorAll('tr[data-member-name]');
                    memberRows.forEach(row => {
                        const cell = row.cells[2]; // 2ì°¨ ê¸°ì—¬ë„
                        if(cell) {
                            const text = cell.textContent.replace('%', '');
                            totalContribution += parseFloat(text) || 0;
                        }
                    });

                    memberRows.forEach(row => {
                        const contributionCell = row.cells[2]; // 2ì°¨ ê¸°ì—¬ë„
                        if(contributionCell) {
                            const contributionText = contributionCell.textContent.replace('%', '');
                            const contribution = parseFloat(contributionText) || 0;
                            const autoCalculatedIncentive = totalContribution > 0 ? (contribution / totalContribution) * incentive2ForDistribution : 0;
                            const incentiveDiv = row.querySelector('.contribution-incentive');
                            if (incentiveDiv) {
                                incentiveDiv.textContent = `${formatCurrency(autoCalculatedIncentive.toFixed(0))} ë§Œì›`;
                            }
                        }
                    });
                }
            };

            card.addEventListener('input', e => {
                if (e.target.matches('.perc-input, .mm-input, .incentive1-input, .lead-perc-input, .final-incentive-input')) {
                    calculate();
                }
            });
            calculate(); // Initial calculation
        });
    }

    // ë°ì´í„° ìˆ˜ì§‘ ë° ì €ì¥
    function collectAndSaveData(isDraft = false) {
        const evaluations = [];
        
        document.querySelectorAll('.card[data-channel-id]').forEach(channelCard => {
            const channelId = channelCard.dataset.channelId;
            const channelComment = channelCard.querySelector('.channel-comment')?.value || '';
            
            // ìµœì¢…ê´€ë¦¬ì í™”ë©´ì˜ ì±„ë„ë³„ ì˜ˆì‚° ì •ë³´
            let channelBudget = {};
            if (currentRole === 'finalApprover') {
                channelBudget = {
                    ì‚¬ì—…íš¨ìœ¨: parseFloat(channelCard.querySelector('.efficiency-input')?.value) || 80,
                    íŒ€ì¥ì„±ê³¼ê¸ˆ: parseFloat(channelCard.querySelector('.incentive1-input')?.value) || 0,
                    íŒ€ì¥ì„±ê³¼: parseFloat(channelCard.querySelector('.lead-perc-input')?.value) || 0
                };
            }
            
            channelCard.querySelectorAll('tr[data-member-id]').forEach(memberRow => {
                const memberId = memberRow.dataset.memberId;
                const memberName = memberRow.dataset.memberName;
                
                // ê¸°ì¡´ í‰ê°€ ë°ì´í„° ì°¾ê¸°
                let evalData = appData.evaluations.find(e => 
                    e['ì±„ë„ID'] === channelId && 
                    e['ë‹´ë‹¹ìID'] === memberId && 
                    e['í‰ê°€ì›”'] === currentMonth
                );
                
                if (!evalData) {
                    // ìƒˆ í‰ê°€ ë°ì´í„° ìƒì„±
                    evalData = {
                        í‰ê°€ID: null, // ì„œë²„ì—ì„œ ìë™ ìƒì„±ë¨
                        í‰ê°€ì›”: currentMonth,
                        ì±„ë„ID: channelId,
                        ë‹´ë‹¹ìID: memberId,
                        ë‹´ë‹¹ìì´ë¦„: memberName
                    };
                } else {
                    // ê¸°ì¡´ ë°ì´í„° ë³µì‚¬
                    evalData = { ...evalData };
                }
                
                // ì—­í• ë³„ë¡œ ë‹¤ë¥¸ ë°ì´í„° ìˆ˜ì§‘
                if (currentRole === 'teamLead') {
                    evalData['íˆ¬ì…MM'] = parseFloat(memberRow.querySelector('.mm-input')?.value) || 0;
                    evalData['1ì°¨ê¸°ì—¬ë„'] = parseFloat(memberRow.querySelector('.perc-input')?.value) || 0;
                    
                    // ì„±ê³¼ í•­ëª© ìˆ˜ì§‘
                    const commentRow = memberRow.nextElementSibling;
                    if (commentRow) {
                        const performances = [];
                        commentRow.querySelectorAll('.performance-item').forEach(item => {
                            const title = item.querySelector('.performance-title')?.value;
                            const value = item.querySelector('.performance-value')?.value;
                            if (title || value) {
                                performances.push(`${title}|${value}`);
                            }
                        });
                        evalData['1ì°¨ì„±ê³¼ê¸ˆ'] = performances.join('||');
                        evalData['1ì°¨ì½”ë©˜íŠ¸'] = commentRow.querySelector('.comment-1')?.value || '';
                    }
                    evalData['1ì°¨í‰ê°€ìƒíƒœ'] = isDraft ? 'ì„ì‹œì €ì¥' : 'ì œì¶œì™„ë£Œ';
                } else if (currentRole === 'manager') {
                    evalData['2ì°¨ê¸°ì—¬ë„'] = parseFloat(memberRow.querySelector('.perc-input')?.value) || 0;
                    
                    const commentRow = memberRow.nextElementSibling;
                    if (commentRow) {
                        evalData['2ì°¨ì½”ë©˜íŠ¸'] = commentRow.querySelector('.comment-2')?.value || '';
                    }
                    evalData['2ì°¨í‰ê°€ìƒíƒœ'] = isDraft ? 'ì„ì‹œì €ì¥' : 'ì œì¶œì™„ë£Œ';
                } else if (currentRole === 'finalApprover') {
                    evalData['ì‹¤ì§€ê¸‰ì„±ê³¼ê¸ˆ'] = parseFloat(memberRow.querySelector('.final-incentive-input')?.value) || 0;
                    evalData['ì‚¬ì—…íš¨ìœ¨'] = channelBudget.ì‚¬ì—…íš¨ìœ¨;
                    evalData['íŒ€ì¥ì„±ê³¼ê¸ˆ'] = channelBudget.íŒ€ì¥ì„±ê³¼ê¸ˆ;
                    evalData['íŒ€ì¥ì„±ê³¼'] = channelBudget.íŒ€ì¥ì„±ê³¼;
                    
                    const commentRow = memberRow.nextElementSibling;
                    if (commentRow) {
                        evalData['ìµœì¢…ì½”ë©˜íŠ¸'] = commentRow.querySelector('.comment-final')?.value || '';
                    }
                    evalData['ìµœì¢…í‰ê°€ìƒíƒœ'] = isDraft ? 'ì„ì‹œì €ì¥' : 'ì œì¶œì™„ë£Œ';
                }
                
                evalData['ì±„ë„ì½”ë©˜íŠ¸'] = channelComment;
                evalData['ë‹´ë‹¹ìì´ë¦„'] = memberName; // ë‹´ë‹¹ì ì´ë¦„ í™•ì‹¤íˆ ì €ì¥
                evaluations.push(evalData);
            });
        });
        
        if (evaluations.length > 0) {
            console.log('ì €ì¥í•  í‰ê°€ ë°ì´í„°:', evaluations);
            saveEvaluationData(evaluations, isDraft);
        } else {
            showError('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ì—­í•  ì „í™˜
    function switchView(role) {
        // currentUserê°€ ì—†ìœ¼ë©´ ë¦¬í„´
        if (!currentUser) {
            console.error('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const roleMap = {
            'teamLead': 'íŒ€ì¥',
            'manager': 'ê´€ë¦¬ì', 
            'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
        };
        
        const permissionMap = {
            'teamLead': '1ì°¨',
            'manager': '2ì°¨',
            'finalApprover': '3ì°¨'
        };
        
        // ê¶Œí•œ ì²´í¬
        if (!currentUser.í‰ê°€ê¶Œí•œ || !currentUser.í‰ê°€ê¶Œí•œ.includes(permissionMap[role])) {
            showError(`${roleMap[role]} í‰ê°€ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        
        currentRole = role;
        
        // viewsê°€ ì œëŒ€ë¡œ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (!views || !views[role]) {
            console.error('View not found:', role);
            return;
        }
        
        // ëª¨ë“  ë·° ìˆ¨ê¸°ê¸°
        Object.values(views).forEach(view => { 
            if (view) {
                view.classList.add('hidden'); 
            }
        });
        
        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        Object.values(buttons).forEach(btn => { 
            if (btn) {
                btn.classList.remove('btn-primary'); 
                btn.classList.add('btn-secondary'); 
            }
        });
        
        buttons[role].classList.remove('btn-secondary');
        buttons[role].classList.add('btn-primary');
        
        // userInfoEl í™•ì¸ í›„ ì—…ë°ì´íŠ¸
        const userInfo = document.getElementById('user-info');
        if (userInfo) {
            userInfo.textContent = `${currentUser.ì´ë¦„}ë‹˜ (${roleMap[role]})`;
        }
        
        // ë°ì´í„° ë¡œë“œ - í•œê¸€ ì—­í• ëª… ì „ë‹¬
        loadData(roleMap[role]);
    }
    
    // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', function() {
        console.log('DOM ë¡œë“œ ì™„ë£Œ');
        
        // DOM ìš”ì†Œ ì´ˆê¸°í™”
        initializeDOMReferences();
        
        // ìš”ì†Œë“¤ì´ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (!buttons.teamLead || !buttons.manager || !buttons.finalApprover || !monthSelect) {
            console.error('í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        buttons.teamLead.addEventListener('click', () => {
            if (currentUser && !buttons.teamLead.disabled) switchView('teamLead');
        });
        buttons.manager.addEventListener('click', () => {
            if (currentUser && !buttons.manager.disabled) switchView('manager');
        });
        buttons.finalApprover.addEventListener('click', () => {
            if (currentUser && !buttons.finalApprover.disabled) switchView('finalApprover');
        });
        
        monthSelect.addEventListener('change', (e) => {
            currentMonth = e.target.value;
            if (currentMonth && currentRole && currentUser) {
                const roleMap = {
                    'teamLead': 'íŒ€ì¥',
                    'manager': 'ê´€ë¦¬ì',
                    'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
                };
                loadData(roleMap[currentRole]); // currentRoleì€ ì˜ë¬¸ì´ë¯€ë¡œ í•œê¸€ë¡œ ë³€í™˜
            }
        });
        
        // íŒ€ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (teamSelect) {
            teamSelect.addEventListener('change', (e) => {
                selectedTeamId = e.target.value;
                if (selectedTeamId && currentRole === 'teamLead') {
                    loadData('íŒ€ì¥');
                }
            });
        }
        
        // Undo ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const undoBtn = document.getElementById('undo-btn');
        if (undoBtn) {
            undoBtn.addEventListener('click', () => {
                if (undoState.element) {
                    undoState.element.style.display = '';
                    hideUndoToast();
                }
            });
        }
        
        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        document.querySelector('.close').addEventListener('click', closeAddMemberModal);
        document.querySelector('#addAdminModal .close').addEventListener('click', closeAddAdminModal);
        
        // ëª¨ë‹¬ ë°– í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', (event) => {
            const modal1 = document.getElementById('addMemberModal');
            const modal2 = document.getElementById('addAdminModal');
            if (event.target === modal1) {
                closeAddMemberModal();
            } else if (event.target === modal2) {
                closeAddAdminModal();
            }
        });

        // ê´€ë¦¬ì ì—­í•  ì„ íƒ ì‹œ ê¸°ë³¸ ê¶Œí•œ ìë™ ì„¤ì •
        document.getElementById('adminRole').addEventListener('change', (e) => {
            const role = e.target.value;
            document.getElementById('adminPerm1').checked = role === 'íŒ€ì¥';
            document.getElementById('adminPerm2').checked = role === 'ê´€ë¦¬ì';
            document.getElementById('adminPerm3').checked = role === 'ìµœì¢…ê´€ë¦¬ì';
        });
        
        // ë‹´ë‹¹ì ì¶”ê°€ í¼ ì œì¶œ - ìˆ˜ì •ë¨
        document.getElementById('addMemberForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const memberData = {
                name: document.getElementById('newMemberName').value,
                role: document.getElementById('newMemberRole').value,
                teamId: pendingMemberData.teamId,
                channelId: pendingMemberData.channelId
            };
            
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        showSuccess('ë‹´ë‹¹ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        closeAddMemberModal();
                        
                        // í™”ë©´ì— ì¦‰ì‹œ ì¶”ê°€
                        const channelCard = document.querySelector(`[data-channel-id="${pendingMemberData.channelId}"]`);
                        if (channelCard) {
                            const newMember = {
                                ë‹´ë‹¹ìID: result.memberId,
                                ì´ë¦„: memberData.name,
                                ì—­í• : memberData.role,
                                ì†Œì†íŒ€ID: memberData.teamId,
                                ì†Œì†ì±„ë„ID: memberData.channelId
                            };
                            
                            // appData.membersì—ë„ ì¶”ê°€
                            if (!appData.members) appData.members = [];
                            appData.members.push(newMember);
                            
                            // í™”ë©´ì— ì¶”ê°€
                            addMemberToChannel(channelCard, newMember, pendingMemberData.channelId);
                        }
                    } else {
                        showError(result.message);
                    }
                    hideLoading();
                })
                .withFailureHandler(error => {
                    console.error('Failed to add member:', error);
                    showError('ë‹´ë‹¹ì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    hideLoading();
                })
                .addMember(memberData);  // addUserê°€ ì•„ë‹Œ addMember í˜¸ì¶œ
        });

        // ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€ í¼ ì œì¶œ
        document.getElementById('addAdminForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            // ì„ íƒëœ íŒ€ë“¤ ê°€ì ¸ì˜¤ê¸°
            const teamSelect = document.getElementById('adminTeam');
            const selectedTeams = Array.from(teamSelect.selectedOptions).map(opt => opt.value);
            
            const adminData = {
                userId: document.getElementById('adminEmail').value, // ì‹œìŠ¤í…œ ê´€ë¦¬ìëŠ” ì´ë©”ì¼ì„ IDë¡œ ì‚¬ìš©
                name: document.getElementById('adminName').value,
                role: document.getElementById('adminRole').value,
                teamId: selectedTeams.join(','), // ë³µìˆ˜ íŒ€ì€ ì‰¼í‘œë¡œ êµ¬ë¶„
                permissions: {
                    perm1: document.getElementById('adminPerm1').checked,
                    perm2: document.getElementById('adminPerm2').checked,
                    perm3: document.getElementById('adminPerm3').checked
                }
            };
            
            showLoading();
            google.script.run
                .withSuccessHandler(result => {
                    if (result.success) {
                        showSuccess('ì‹œìŠ¤í…œ ê´€ë¦¬ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        closeAddAdminModal();
                        // ë°ì´í„° ë¦¬í”„ë ˆì‹œ
                        const roleMap = {
                            'teamLead': 'íŒ€ì¥',
                            'manager': 'ê´€ë¦¬ì',
                            'finalApprover': 'ìµœì¢…ê´€ë¦¬ì'
                        };
                        loadData(roleMap[currentRole]);
                    } else {
                        showError(result.message);
                    }
                    hideLoading();
                })
                .withFailureHandler(error => {
                    console.error('Failed to add admin:', error);
                    showError('ì‹œìŠ¤í…œ ê´€ë¦¬ì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    hideLoading();
                })
                .addUser(adminData);
        });
        
        // ì´ˆê¸°í™” ì‹œì‘
        initializeApp();
    });
    </script>
</body>
</html>
